<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="description" content="RMC Commercial Team - Quick access to Daily Counting, Stock Counting, Employee Attendance, and Dashboard" />
  <meta name="keywords" content="RMC, commercial, daily counting, stock counting, attendance, dashboard" />
  <meta name="author" content="RMC Commercial Team" />
  <meta name="theme-color" content="#f6f7fb" />
  <title>RMC Commercial Team</title>

  <!-- Performance hints -->
  <link rel="dns-prefetch" href="//fonts.googleapis.com">
  <link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin />
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin />
  <link rel="preconnect" href="https://script.google.com" crossorigin />
  <link rel="preconnect" href="https://docs.google.com" crossorigin />

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet" />

  <style>
    :root{
      --bg:#f6f7fb;
      --surface:#ffffff;
      --surface-border:rgba(17,24,39,.08);
      --text:#111827;
      --muted:#6b7280;
      --primary:#16a34a;
      --primary-2:#15803d;
      --radius:16px;
      --shadow:0 12px 28px rgba(0,0,0,.08);
      --ring: 0 0 0 3px rgba(22,163,74,.35);
      --dur-fast:.15s;
      --dur:.28s;

      /* App-specific accent colors and ripple (RGBA) */
      --c-daily: #22c55e;       --r-daily: rgba(34,197,94,.28);
      --c-stock: #3b82f6;       --r-stock: rgba(59,130,246,.28);
      --c-attendance: #8b5cf6;  --r-attendance: rgba(139,92,246,.28);
    }
    html[data-theme="dark"]{
      --bg:#0f172a;
      --surface:#111827;
      --surface-border:rgba(255,255,255,.08);
      --text:#f3f4f6;
      --muted:#9ca3af;
      --shadow:0 12px 28px rgba(0,0,0,.32);
      --ring: 0 0 0 3px rgba(99,102,241,.45);
    }

    *{box-sizing:border-box}
    html,body{height:100%;scroll-behavior:smooth}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:'Roboto',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      -webkit-tap-highlight-color: transparent;
    }

    /* Skip link */
    .skip-link{
      position:absolute; left:12px; top:-40px; z-index:10002;
      background:#111827; color:#fff; padding:8px 12px; border-radius:8px;
      transition: top var(--dur);
      text-decoration:none; font-weight:600;
    }
    .skip-link:focus{ top:12px; box-shadow: var(--ring); outline:none; }
    html[data-theme="dark"] .skip-link{ background:#fff; color:#111827; }

    /* Offline banner */
    .offline{
      position:fixed;top:0;left:0;right:0;z-index:10001;
      display:none;align-items:center;justify-content:center;gap:8px;
      background:#111827;color:#fff;padding:8px 12px;font-size:12px;
    }
    .offline.show{ display:flex; }
    .offline i{ color:#f59e0b; }
    html[data-theme="dark"] .offline{ background:#0b1220; }

    /* Container */
    .main-content{
      position:relative; z-index:1; max-width: 880px;
      margin: clamp(16px,6vh,48px) auto calc(56px + env(safe-area-inset-bottom));
      background: var(--surface);
      border-radius: var(--radius);
      padding: clamp(20px, 4vw, 32px);
      box-shadow: var(--shadow);
      border: 1px solid var(--surface-border);
    }

    /* Top actions */
    .top-actions{ display:flex;justify-content:space-between;align-items:center;margin-bottom:8px; }
    .theme-toggle{
      width:40px;height:40px;border-radius:10px;
      display:grid;place-items:center;cursor:pointer;border:1px solid var(--surface-border);
      background:transparent;color:var(--muted);
      transition: transform var(--dur), box-shadow var(--dur), color var(--dur), background var(--dur);
    }
    .theme-toggle:hover{ transform: translateY(-1px); color:var(--text); }
    .theme-toggle:focus-visible{ outline:none; box-shadow: var(--ring); }

    /* Hero */
    .hero{ display:flex;flex-direction:column;align-items:center;text-align:center; }
    .app-logo img{
      height:90px; width:auto; max-width: 240px;
      border-radius:12px;
      background:transparent;
      border:1px solid var(--surface-border);
      box-shadow: 0 6px 18px rgba(0,0,0,.06);
      padding: 12px; display:block;
    }
    .app-name{ font-size: clamp(22px, 3.5vw, 30px); font-weight:800; margin: 20px 0 6px; letter-spacing:.2px; }
    .app-description{ font-size:14px; color:var(--muted); margin-bottom:24px; max-width:560px; line-height:1.6; }

    /* Dock actions (with color ripple select effect) */
    .action-dock{
      display:flex; gap:16px; flex-wrap:wrap; justify-content:center; margin-bottom: 22px;
    }
    .dock-item{
      display:flex; flex-direction:column; align-items:center; gap:10px;
      cursor:pointer; background:transparent; border:none; padding:0; color:inherit;
    }
    .dock-icon{
      position:relative; overflow:hidden;
      width:92px; height:92px; border-radius:16px; display:grid; place-items:center;
      border:1px solid var(--surface-border); background: var(--surface);
      box-shadow: 0 6px 18px rgba(0,0,0,.08);
      transition: transform var(--dur), box-shadow var(--dur), filter var(--dur);
      font-size:28px; color:var(--primary);
    }
    .dock-item:hover .dock-icon{ transform: translateY(-2px); box-shadow: 0 10px 26px rgba(0,0,0,.12); }
    .dock-item:active .dock-icon{ transform: translateY(1px) scale(0.98); filter: brightness(.95); transition-duration: var(--dur-fast); }
    .dock-label{ font-size:13px; color:var(--text); font-weight:500; }
    .dock-item:focus-visible{ outline:none; }
    .dock-item:focus-visible .dock-icon{ box-shadow: var(--ring); }

    /* Ripple/Select color effect */
    .dock-icon::after{
      content:''; position:absolute; top:var(--py,50%); left:var(--px,50%);
      width:0; height:0; transform: translate(-50%,-50%); border-radius:50%;
      background: var(--accent-ripple, rgba(22,163,74,.28));
      opacity:.85; pointer-events:none;
      transition: width 620ms ease, height 620ms ease, opacity 780ms ease;
    }
    .dock-item.ripple .dock-icon::after{
      width:220px; height:220px; opacity:0;
    }

    /* Assign accent and ripple colors per button */
    #launchBtn{ --accent-color: var(--c-daily); --accent-ripple: var(--r-daily); }
    #stockBtn{ --accent-color: var(--c-stock); --accent-ripple: var(--r-stock); }
    #attendanceBtn{ --accent-color: var(--c-attendance); --accent-ripple: var(--r-attendance); }

    /* Quick actions */
    .app-grid{
      display:flex; justify-content:center; gap: 16px;
      border-top: 1px solid var(--surface-border);
      padding-top: 18px; margin-top:10px; width:100%; max-width: 520px; margin-left:auto;margin-right:auto;
    }
    .grid-item button{ background:none; border:1px solid var(--surface-border); color:var(--muted); padding:0; cursor:pointer; border-radius:12px; }
    .grid-icon{
      width:48px; height:48px; border-radius:12px; display:grid; place-items:center;
      transition: transform var(--dur), color var(--dur), background var(--dur), border-color var(--dur);
      background: var(--surface);
    }
    .grid-item button:hover .grid-icon{ color:var(--primary); transform:translateY(-1px); border-color: rgba(22,163,74,.35); }
    .grid-item button:focus-visible{ outline:none; box-shadow: var(--ring); }

    /* Progress/Loading/Modal */
    .progress-bar, .loading-overlay, .modal{ content-visibility: auto; }
    .progress-bar{
      position: fixed; top: 0; left: 0; height: 3px; width: 0%;
      background: linear-gradient(90deg, var(--primary), var(--primary-2));
      z-index: 10000; transition: width .35s ease;
    }
    .loading-overlay{
      position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
      background: rgba(0,0,0,.3); backdrop-filter: blur(4px);
      z-index: 9999; opacity:0; visibility:hidden; transition: opacity var(--dur), visibility var(--dur);
    }
    .loading-overlay.active{ opacity:1; visibility:visible; }
    .loading-box{ display:flex;flex-direction:column;align-items:center;gap:14px;color:#fff;text-align:center; }
    .loading-spinner{
      width:48px;height:48px;border:4px solid rgba(255,255,255,.35);border-top-color:#fff;border-radius:50%;
      animation: spin 1s linear infinite;
    }
    .loading-text{ font-size:15px;font-weight:600; }

    .modal{
      position:fixed;inset:0;display:none;align-items:center;justify-content:center;
      background: rgba(0,0,0,.35); z-index: 9998;
    }
    .modal.show{ display:flex; }
    .modal-dialog{
      width:min(92vw,520px);
      background:var(--surface);border-radius:12px;box-shadow: var(--shadow);
      transform: translateY(8px); opacity:0; animation: modalIn .28s ease forwards;
      color:var(--text); border:1px solid var(--surface-border);
    }
    .modal-header{
      display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--surface-border);
    }
    .modal-title{ font-weight:700; }
    .modal-close{
      background:transparent;border:1px solid var(--surface-border);font-size:16px;cursor:pointer;color:var(--muted);
      padding:6px 8px;border-radius:8px;transition: background var(--dur), color var(--dur), border-color var(--dur);
    }
    .modal-close:hover{ background:rgba(0,0,0,.04); color:var(--text); border-color: rgba(0,0,0,.15); }
    html[data-theme="dark"] .modal-close:hover{ background:rgba(255,255,255,.06); border-color: rgba(255,255,255,.18); }
    .modal-body{ padding:14px 16px; line-height:1.6; }

    /* Toggle switch style (Settings) */
    .switch{ position:relative; display:inline-block; width:44px; height:24px; vertical-align:middle; }
    .switch input{ display:none; }
    .switch .slider{
      position:absolute; inset:0; background:#cbd5e1; border-radius:24px; transition: background var(--dur);
    }
    .switch .slider::before{
      content:''; position:absolute; left:3px; top:3px; width:18px; height:18px; background:#fff; border-radius:50%; transition: transform var(--dur);
      box-shadow: 0 2px 6px rgba(0,0,0,.15);
    }
    .switch input:checked + .slider{ background: var(--primary); }
    .switch input:checked + .slider::before{ transform: translateX(20px); }

    /* Watermark */
    .watermark{
      position: fixed; left:0; right:0; bottom:0;
      background: rgba(17,24,39,.85); color:#fff; display:flex; justify-content:space-between; align-items:center;
      padding: 10px 16px calc(10px + env(safe-area-inset-bottom));
      font-size:12px; z-index: 900;
    }
    html[data-theme="dark"] .watermark{ background: rgba(0,0,0,.7); }

    /* Animations */
    @keyframes spin{ to{ transform: rotate(360deg); } }
    @keyframes modalIn{ from{ opacity:0; transform: translateY(8px);} to{ opacity:1; transform: translateY(0);} }

    @media (prefers-reduced-motion: reduce) {
      *{ animation: none !important; transition: none !important; }
    }

    @media (max-width: 540px){
      .dock-icon{ width:84px; height:84px; font-size:26px; }
      .action-dock{ gap:12px; }
      .app-grid{ gap:12px; }
    }
  </style>
</head>
<body>
  <a class="skip-link" href="#main">Skip to content</a>
  <div class="offline" id="offlineBanner" role="status" aria-live="polite">
    <i class="fa-solid fa-triangle-exclamation"></i> <span data-i18n="offline">You’re offline. Some actions may not work.</span>
  </div>
  <noscript>
    <div style="position:fixed;inset:0;background:#111827;color:#fff;display:flex;align-items:center;justify-content:center;z-index:100000;text-align:center;padding:20px;">
      This page requires JavaScript to launch applications. Please enable it.
    </div>
  </noscript>

  <!-- Optional local track (place assets/bgm.mp3). Current build prefers relax synth. -->
  <audio id="bgm" src="assets/bgm.mp3" preload="auto" loop crossorigin="anonymous"></audio>

  <div class="progress-bar" id="progressBar" aria-hidden="true"></div>

  <div class="loading-overlay" id="loadingOverlay" role="alert" aria-live="polite" aria-busy="true">
    <div class="loading-box">
      <div class="loading-spinner" aria-hidden="true"></div>
      <div class="loading-text" id="loadingText">Loading...</div>
    </div>
  </div>

  <div class="modal" id="modal" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="modalTitle">
    <div class="modal-dialog" role="document">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">Title</div>
        <button class="modal-close" type="button" id="modalClose" aria-label="Close">
          <i class="fa fa-times"></i>
        </button>
      </div>
      <div class="modal-body" id="modalBody">Body</div>
    </div>
  </div>

  <main class="main-content" id="main" aria-busy="false">
    <div class="top-actions">
      <div></div>
      <button id="themeToggle" class="theme-toggle" aria-label="Toggle theme" title="Toggle theme">
        <i class="fa-solid fa-sun" id="themeIcon"></i>
      </button>
    </div>

    <section class="hero" aria-label="Application Launcher">
      <div class="app-logo" role="img" aria-label="RMC Logo">
        <img src="https://synques-cdn.s3.ap-south-1.amazonaws.com/rmchemicals.in/images/rmc-logo.png"
             alt="RMC Logo" loading="eager" decoding="async" fetchpriority="high" />
      </div>
      <h1 class="app-name" data-i18n="appName">RMC Commercial Team</h1>
      <p class="app-description" data-i18n="description">
        Quickly access Daily Counting, Stock Counting, Employee Attendance, and Dashboard tools.
      </p>

      <!-- Primary actions -->
      <div class="action-dock" role="list">
        <button class="dock-item" id="launchBtn" aria-label="Open Daily Counting">
          <div class="dock-icon"><i class="fa-solid fa-list-check" aria-hidden="true"></i></div>
          <span class="dock-label" data-i18n="daily">Daily Counting</span>
        </button>
        <button class="dock-item" id="stockBtn" aria-label="Open Stock Counting">
          <div class="dock-icon"><i class="fa-solid fa-boxes-stacked" aria-hidden="true"></i></div>
          <span class="dock-label" data-i18n="stock">Stock Counting</span>
        </button>
        <button class="dock-item" id="attendanceBtn" aria-label="Open Employee Attendance Record">
          <div class="dock-icon"><i class="fa-solid fa-user-check" aria-hidden="true"></i></div>
          <span class="dock-label" data-i18n="attendance">Attendance</span>
        </button>
      </div>

      <!-- Quick actions -->
      <nav class="app-grid" aria-label="Quick actions">
        <div class="grid-item">
          <button class="grid-icon" data-action="settings" aria-label="Settings" title="Settings">
            <i class="fas fa-gear" aria-hidden="true"></i>
          </button>
        </div>
        <div class="grid-item">
          <button class="grid-icon" data-action="info" aria-label="Info" title="Info">
            <i class="fas fa-circle-info" aria-hidden="true"></i>
          </button>
        </div>
        <div class="grid-item">
          <button class="grid-icon" data-action="help" aria-label="Help" title="Help">
            <i class="fas fa-circle-question" aria-hidden="true"></i>
          </button>
        </div>
        <div class="grid-item">
          <button class="grid-icon" data-action="dashboard" aria-label="Dashboard" title="Dashboard">
            <i class="fas fa-chart-bar" aria-hidden="true"></i>
          </button>
        </div>
      </nav>
    </section>
  </main>

  <footer class="watermark" aria-label="Watermark">
    <div class="watermark-left">
      <div>Department: Commercial Team</div>
      <div>Modify Admin: Lakshan</div>
    </div>
    <div class="watermark-right">
      <i class="fas fa-building" aria-hidden="true"></i> RMC Commercial Team
    </div>
  </footer>

  <script>
    (function(){
      'use strict';

      const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyZwQrxxXeDnT1llTZb3h7Mj059z4y_3JuKnmQ2p5yIdQXbxttoDblg4coapbSy-gkq/exec';
      const STOCK_SCRIPT_URL  = 'https://script.google.com/macros/s/AKfycbzGxPTe-ex9-JX3r1olSyV5MCAb_RAP01DuMiG_2rUk1K2my89lzP2wLrwVruYmdw47/exec';
      const ATTENDANCE_URL    = 'https://rmc.timelabs.in/';
      const DASHBOARD_URL     = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRxRoqXa5h87pfYymuSXbHsuvR90a6Uu5U8JTa6mIbT4LORwb8mUeSRWqYHH14aWtHpcBIlJgXlRY0e/pubhtml';

      // Elements
      const progressBar   = document.getElementById('progressBar');
      const loadingOverlay= document.getElementById('loadingOverlay');
      const loadingText   = document.getElementById('loadingText');
      const launchBtn     = document.getElementById('launchBtn');
      const stockBtn      = document.getElementById('stockBtn');
      const attendanceBtn = document.getElementById('attendanceBtn');
      const modal         = document.getElementById('modal');
      const modalClose    = document.getElementById('modalClose');
      const modalTitle    = document.getElementById('modalTitle');
      const modalBody     = document.getElementById('modalBody');
      const themeToggle   = document.getElementById('themeToggle');
      const themeIcon     = document.getElementById('themeIcon');
      const offlineBanner = document.getElementById('offlineBanner');
      const main          = document.getElementById('main');
      const bgmEl         = document.getElementById('bgm');

      let didNavigate = false;
      let lastFocused = null;

      // Music state & engine
      // Prefer the built-in "mind relax" synth melody by default
      const preferSynth = true;
      let musicOn = (localStorage.getItem('musicOn') || '0') === '1';
      let audioCtx = null;
      let masterGain = null, dryGain = null, wetGain = null, delay = null, feedback = null;
      let padOsc1 = null, padOsc2 = null, padGain = null, padFilter = null, lfo = null, lfoGain = null;
      let melodyTimer = null, scheduleTimer = null, nextNoteTime = 0;
      const lookahead = 0.10; // seconds
      const scheduleAheadTime = 1.0; // seconds

      // i18n
      const I18N = {
        en: {
          appName: 'RMC Commercial Team',
          description: 'Quickly access Daily Counting, Stock Counting, Employee Attendance, and Dashboard tools.',
          daily: 'Daily Counting',
          stock: 'Stock Counting',
          attendance: 'Attendance',
          info: 'Info',
          settings: 'Settings',
          help: 'Help',
          dashboard: 'Dashboard',
          offline: 'You’re offline. Some actions may not work.',
          opening: 'Opening {label}...',
          unableOpenTitle: 'Unable to open',
          unableOpenBody: 'We couldn’t open {label}. Please try again or check your network.',
          offlineTitle: 'You are offline',
          offlineBody: 'Cannot open {label} while offline. Please check your connection.',
          settingsTitle: 'Application Settings',
          settingsIntro: 'Configure your preferences.',
          language: 'Language',
          theme: 'Theme',
          light: 'Light',
          dark: 'Dark',
          bgm: 'Background music',
          bgmNote: 'Music starts after your first click due to browser policy.',
          langUpdated: 'Language updated.'
        },
        si: {
          appName: 'RMC වාණිජ කණ්ඩායම',
          description: 'Daily Counting, Stock Counting, සේවක පැමිණීම සහ Dashboard මෙවලම් වේගයෙන් ප්‍රවේශ වන්න.',
          daily: 'දෛනික ගණනය',
          stock: 'කොටස් ගණනය',
          attendance: 'සේවක පැමිණීම',
          info: 'තොරතුරු',
          settings: 'සැකසුම්',
          help: 'උදව්',
          dashboard: 'ඩෑෂ්බෝඩ්',
          offline: 'ඔබ අන්තර්ජාලයට සම්බන්ධ නොවෙයි. සමහර ක්‍රියා නොවිය හැක.',
          opening: '{label} විවෘත කරයි...',
          unableOpenTitle: 'විවෘත කළ නොහැකි විය',
          unableOpenBody: '{label} විවෘත කළ නොහැකි විය. නැවත උත්සාහ කරන්න හෝ ජාල සම්බන්ධතාවය පරීක්ෂා කරන්න.',
          offlineTitle: 'ඔබ සබැඳි නොවෙයි',
          offlineBody: 'අන්තර්ජාලයේ නොමැතිව {label} විවෘත කළ නොහැක. කරුණාකර සම්බන්ධතාවය පරීක්ෂා කරන්න.',
          settingsTitle: 'යෙදුම් සැකසුම්',
          settingsIntro: 'ඔබගේ අභිරුචි සකසන්න.',
          language: 'භාෂාව',
          theme: 'තේමාව',
          light: 'ආලෝක',
          dark: 'අඳුරු',
          bgm: 'පසුබිම් සංගීතය',
          bgmNote: 'ඔබගේ ප්‍රථම ක්ලික් පසු සංගීතය ආරම්භ වේ (බ්‍රවුසර නීතිය).',
          langUpdated: 'භාෂාව යාවත්කාලීන විය.'
        },
        ta: {
          appName: 'RMC வர்த்தக குழு',
          description: 'Daily Counting, Stock Counting, பணியாளர் வருகை மற்றும் Dashboard கருவிகளை விரைவாக அணுகவும்.',
          daily: 'தினசரி எண்ணிக்கை',
          stock: 'சரக்கு எண்ணிக்கை',
          attendance: 'வருகை',
          info: 'தகவல்',
          settings: 'அமைப்புகள்',
          help: 'உதவி',
          dashboard: 'டாஷ்போர்டு',
          offline: 'இணையம் இல்லை. சில செயல்கள் இயங்காது.',
          opening: '{label} திறக்கப்படுகிறது...',
          unableOpenTitle: 'திறக்க முடியவில்லை',
          unableOpenBody: '{label} திறக்க முடியவில்லை. மீண்டும் முயற்சிக்கவும் அல்லது நெட்வொர்க் சரிபார்க்கவும்.',
          offlineTitle: 'நீங்கள் ஆஃப்லைனில் உள்ளீர்கள்',
          offlineBody: 'ஆஃப்லைனில் {label} திறக்க முடியாது. இணைப்பைச் சரிபார்க்கவும்.',
          settingsTitle: 'பயன்பாட்டு அமைப்புகள்',
          settingsIntro: 'உங்கள் விருப்பங்களை அமைக்கவும்.',
          language: 'மொழி',
          theme: 'தீம்',
          light: 'ஒளி',
          dark: 'கருப்பு',
          bgm: 'பின்னணி இசை',
          bgmNote: 'உங்கள் முதல் கிளிக்கிற்குப் பின் இசை துவங்கும் (உலாவி கொள்கை).',
          langUpdated: 'மொழி புதுப்பிக்கப்பட்டது.'
        }
      };
      let currentLang = localStorage.getItem('lang') || 'en';

      const t = (key) => (I18N[currentLang] && I18N[currentLang][key]) || I18N.en[key] || key;
      const tf = (key, params={}) => {
        let s = t(key);
        Object.entries(params).forEach(([k,v]) => { s = s.split(`{${k}}`).join(v); });
        return s;
      };

      const applyTranslations = () => {
        document.querySelectorAll('[data-i18n]').forEach(el=>{
          const key = el.getAttribute('data-i18n');
          el.textContent = t(key);
        });
        document.querySelectorAll('.grid-item button').forEach(btn=>{
          const action = btn.dataset.action;
          const label = t(action);
          btn.setAttribute('aria-label', label);
          btn.setAttribute('title', label);
        });
        const off = document.querySelector('.offline [data-i18n="offline"]');
        if (off) off.textContent = t('offline');
        document.documentElement.lang = currentLang;
      };

      // Theme
      const updateThemeIcon = () => {
        const theme = document.documentElement.getAttribute('data-theme') || 'light';
        themeIcon.className = theme === 'dark' ? 'fa-solid fa-moon' : 'fa-solid fa-sun';
        themeToggle.setAttribute('aria-label', `Switch to ${theme === 'dark' ? 'light' : 'dark'} mode`);
      };
      const setTheme = (theme) => {
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
        updateThemeIcon();
      };
      const getPreferredTheme = () => {
        const saved = localStorage.getItem('theme');
        if (saved) return saved;
        return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      };

      // Loading
      const showLoading = (message = 'Loading...') => {
        main.setAttribute('aria-busy', 'true');
        loadingText.textContent = message;
        loadingOverlay.classList.add('active');
        progressBar.style.width = '0%';
        requestAnimationFrame(() => {
          setTimeout(()=>progressBar.style.width='30%', 120);
          setTimeout(()=>progressBar.style.width='70%', 520);
          setTimeout(()=>progressBar.style.width='100%', 1000);
        });
      };
      const hideLoading = () => {
        main.setAttribute('aria-busy', 'false');
        setTimeout(()=>{ loadingOverlay.classList.remove('active'); progressBar.style.width = '0%'; }, 280);
      };

      // Ripple effect
      const addRipple = (btn, e) => {
        const icon = btn.querySelector('.dock-icon');
        if (!icon) return;
        const rect = icon.getBoundingClientRect();
        const cx = e && (e.clientX || (e.touches && e.touches[0] && e.touches[0].clientX));
        const cy = e && (e.clientY || (e.touches && e.touches[0] && e.touches[0].clientY));
        const x = (cx !== undefined ? cx : rect.left + rect.width/2) - rect.left;
        const y = (cy !== undefined ? cy : rect.top + rect.height/2) - rect.top;
        icon.style.setProperty('--px', `${x}px`);
        icon.style.setProperty('--py', `${y}px`);
        btn.classList.remove('ripple');
        void icon.offsetWidth;
        btn.classList.add('ripple');
        setTimeout(()=>btn.classList.remove('ripple'), 650);
      };

      // Modal + focus trap
      const focusableSelector = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
      let trapHandler = null;
      const trapFocus = (container) => {
        const nodes = Array.from(container.querySelectorAll(focusableSelector)).filter(el => !el.disabled);
        if (!nodes.length) return;
        const first = nodes[0], last = nodes[nodes.length - 1];
        trapHandler = (e) => {
          if (e.key !== 'Tab') return;
          if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }
          else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
        };
        container.addEventListener('keydown', trapHandler);
      };
      const untrapFocus = (container) => {
        if (trapHandler) container.removeEventListener('keydown', trapHandler);
        trapHandler = null;
      };
      const openModal = (title, contentHTML) => {
        lastFocused = document.activeElement;
        modalTitle.textContent = title;
        modalBody.innerHTML = contentHTML;
        modal.classList.add('show');
        modal.setAttribute('aria-hidden', 'false');
        setTimeout(()=>modalClose.focus(), 30);
        trapFocus(modal);
      };
      const closeModal = () => {
        modal.classList.remove('show');
        modal.setAttribute('aria-hidden', 'true');
        untrapFocus(modal);
        if (lastFocused && typeof lastFocused.focus === 'function') lastFocused.focus();
      };

      // Relax melody synth engine (pad + slow pentatonic melody)
      const ensureAudioCtx = async () => {
        if (!audioCtx) {
          const Ctx = window.AudioContext || window.webkitAudioContext;
          if (Ctx) audioCtx = new Ctx();
        }
        if (audioCtx && audioCtx.state === 'suspended') {
          try { await audioCtx.resume(); } catch(e){}
        }
      };

      const buildGraph = async () => {
        await ensureAudioCtx();
        if (!audioCtx) return;
        if (masterGain) return; // already built

        masterGain = audioCtx.createGain();
        masterGain.gain.value = 0.25;

        dryGain = audioCtx.createGain();
        dryGain.gain.value = 0.8;

        wetGain = audioCtx.createGain();
        wetGain.gain.value = 0.35;

        delay = audioCtx.createDelay(1.2);
        delay.delayTime.value = 0.38;

        feedback = audioCtx.createGain();
        feedback.gain.value = 0.28;

        // Feedback loop: delay -> feedback -> delay
        delay.connect(feedback);
        feedback.connect(delay);

        // Wet chain to master
        delay.connect(wetGain);

        // Mix to master
        dryGain.connect(masterGain);
        wetGain.connect(masterGain);
        masterGain.connect(audioCtx.destination);
      };

      const midiToFreq = (m) => 440 * Math.pow(2, (m - 69) / 12);

      const startPad = () => {
        if (!audioCtx) return;
        stopPad();

        padGain = audioCtx.createGain();
        padGain.gain.value = 0.05;

        padFilter = audioCtx.createBiquadFilter();
        padFilter.type = 'lowpass';
        padFilter.frequency.value = 900;

        padOsc1 = audioCtx.createOscillator();
        padOsc1.type = 'sine';
        padOsc1.frequency.value = 220; // A3

        padOsc2 = audioCtx.createOscillator();
        padOsc2.type = 'triangle';
        padOsc2.frequency.value = 330; // E4
        padOsc2.detune.value = 2;

        // Gentle LFO on pad amplitude
        lfo = audioCtx.createOscillator();
        lfo.frequency.value = 0.12; // very slow
        lfoGain = audioCtx.createGain();
        lfoGain.gain.value = 0.02;
        lfo.connect(lfoGain);
        lfoGain.connect(padGain.gain);

        padOsc1.connect(padFilter);
        padOsc2.connect(padFilter);
        padFilter.connect(padGain);
        padGain.connect(dryGain);

        padOsc1.start();
        padOsc2.start();
        lfo.start();
      };

      const stopPad = () => {
        try { if (padOsc1) padOsc1.stop(); } catch(e){}
        try { if (padOsc2) padOsc2.stop(); } catch(e){}
        try { if (lfo) lfo.stop(); } catch(e){}
        padOsc1 = padOsc2 = null;
        lfo = lfoGain = padGain = padFilter = null;
      };

      const scheduleNote = (time, freq) => {
        if (!audioCtx) return;
        const osc1 = audioCtx.createOscillator();
        osc1.type = 'sine';
        osc1.frequency.value = freq;

        const osc2 = audioCtx.createOscillator();
        osc2.type = 'triangle';
        osc2.frequency.value = freq * 2;
        osc2.detune.value = -5;

        const nFilter = audioCtx.createBiquadFilter();
        nFilter.type = 'lowpass';
        nFilter.frequency.value = 2200;

        const nGain = audioCtx.createGain();
        nGain.gain.setValueAtTime(0, time);
        nGain.gain.linearRampToValueAtTime(0.12, time + 0.02);
        nGain.gain.exponentialRampToValueAtTime(0.0005, time + 3.2);

        // Dry + wet (delay) sends
        osc1.connect(nFilter);
        osc2.connect(nFilter);
        nFilter.connect(nGain);

        // Split to dry and wet
        const nDry = audioCtx.createGain();
        nDry.gain.value = 1.0;
        const nWet = audioCtx.createGain();
        nWet.gain.value = 0.6;

        nGain.connect(nDry);
        nGain.connect(nWet);

        nDry.connect(dryGain);
        nWet.connect(delay);

        osc1.start(time);
        osc2.start(time);
        osc1.stop(time + 3.4);
        osc2.stop(time + 3.4);
      };

      const randomFrom = (arr) => arr[Math.floor(Math.random()*arr.length)];

      const startMelody = () => {
        if (!audioCtx) return;
        // A minor pentatonic over two octaves
        const scale = [0, 3, 5, 7, 10]; // semitone offsets
        const roots = [57, 69]; // A3 (220), A4 (440)
        nextNoteTime = audioCtx.currentTime + 0.2;

        // Scheduling loop
        const scheduler = () => {
          const now = audioCtx.currentTime;
          while (nextNoteTime < now + scheduleAheadTime) {
            const root = randomFrom(roots);
            const semitone = randomFrom(scale);
            const note = root + semitone + (Math.random() < 0.25 ? -12 : 0); // sometimes drop an octave
            const freq = midiToFreq(note);
            scheduleNote(nextNoteTime, freq);
            // next note in 1.6 - 2.8 seconds
            nextNoteTime += 1.6 + Math.random() * 1.2;
          }
        };
        scheduleTimer = setInterval(scheduler, lookahead * 1000);
      };

      const stopMelody = () => {
        if (scheduleTimer) clearInterval(scheduleTimer);
        scheduleTimer = null;
      };

      const startRelaxSynth = async () => {
        await buildGraph();
        startPad();
        startMelody();
      };

      const stopRelaxSynth = () => {
        stopPad();
        stopMelody();
      };

      const playAudioEl = async () => {
        if (!bgmEl) return false;
        try {
          bgmEl.volume = 0.18;
          const p = bgmEl.play();
          if (p && typeof p.then === 'function') await p;
          return true;
        } catch(e) {
          return false;
        }
      };

      const startMusic = async () => {
        if (!musicOn) return;
        if (preferSynth) {
          await startRelaxSynth();
          return;
        }
        // If you want to prefer a file instead, set preferSynth=false
        const ok = await playAudioEl();
        if (!ok) await startRelaxSynth();
      };

      const stopMusic = () => {
        try { if (bgmEl) bgmEl.pause(); } catch(e){}
        stopRelaxSynth();
      };

      // Settings (Language + Music toggle)
      const openSettings = () => {
        const checked = musicOn ? 'checked' : '';
        const settingsHTML = `
          <div style="display:grid; gap:14px;">
            <p style="margin:0; color:var(--muted);">${t('settingsIntro')}</p>

            <div style="display:grid; gap:6px;">
              <label for="langSelect" style="font-weight:600;">${t('language')}</label>
              <select id="langSelect" style="padding:8px 10px; border-radius:8px; border:1px solid var(--surface-border); background:var(--surface); color:var(--text);">
                <option value="en"${currentLang==='en'?' selected':''}>English</option>
                <option value="si"${currentLang==='si'?' selected':''}>සිංහල (Sinhala)</option>
                <option value="ta"${currentLang==='ta'?' selected':''}>தமிழ் (Tamil)</option>
              </select>
            </div>

            <div style="display:flex; align-items:center; justify-content:space-between;">
              <label for="musicToggle" style="font-weight:600;">${t('bgm')}</label>
              <label class="switch">
                <input type="checkbox" id="musicToggle" ${checked} />
                <span class="slider"></span>
              </label>
            </div>
            <small style="color:var(--muted);">${t('bgmNote')}</small>
          </div>
        `;
        openModal(t('settingsTitle'), settingsHTML);

        const langSelect = document.getElementById('langSelect');
        if (langSelect) {
          langSelect.addEventListener('change', (e)=>{
            currentLang = e.target.value;
            localStorage.setItem('lang', currentLang);
            applyTranslations();
          });
        }

        const musicToggle = document.getElementById('musicToggle');
        if (musicToggle) {
          musicToggle.addEventListener('change', async (e)=>{
            musicOn = e.target.checked;
            localStorage.setItem('musicOn', musicOn ? '1' : '0');
            if (musicOn) { await startMusic(); }
            else { stopMusic(); }
          });
        }
      };

      const openInfo = () => {
        openModal(t('info'), `
          <strong>${t('appName')}</strong><br/>
          ${t('description')}
          <br/><br/>
          <strong>Admin:</strong> Lakshan • 0772892711
        `);
      };
      const openHelp = () => {
        openModal(t('help'), `
          • ${t('daily')} • ${t('stock')} • ${t('attendance')} • ${t('dashboard')}<br/>
          ${t('settingsIntro')}
        `);
      };

      // Navigation with fallback
      window.addEventListener('beforeunload', ()=> { didNavigate = true; });
      const safeNavigate = (url, labelKey) => {
        const label = t(labelKey);
        if (!navigator.onLine) {
          openModal(t('offlineTitle'), tf('offlineBody', {label}));
          return;
        }
        showLoading(tf('opening', {label}));
        const timeout = setTimeout(()=>{
          if (!didNavigate && document.visibilityState === 'visible') {
            hideLoading();
            openModal(t('unableOpenTitle'), tf('unableOpenBody', {label}));
          }
        }, 6000);
        setTimeout(()=>{ window.location.href = url; clearTimeout(timeout); }, 900);
      };

      const launchDaily      = (e) => { addRipple(launchBtn, e); safeNavigate(GOOGLE_SCRIPT_URL, 'daily'); };
      const launchStock      = (e) => { addRipple(stockBtn, e); safeNavigate(STOCK_SCRIPT_URL, 'stock'); };
      const launchAttendance = (e) => { addRipple(attendanceBtn, e); safeNavigate(ATTENDANCE_URL, 'attendance'); };
      const openDashboard    = ()  => { safeNavigate(DASHBOARD_URL, 'dashboard'); };

      const setOfflineBanner = () => { offlineBanner.classList.toggle('show', !navigator.onLine); };

      // Bindings
      ['pointerdown','touchstart'].forEach(evt=>{
        launchBtn.addEventListener(evt, (e)=> addRipple(launchBtn, e), {passive:true});
        stockBtn.addEventListener(evt, (e)=> addRipple(stockBtn, e), {passive:true});
        attendanceBtn.addEventListener(evt, (e)=> addRipple(attendanceBtn, e), {passive:true});
      });
      launchBtn.addEventListener('click', launchDaily);
      stockBtn.addEventListener('click', launchStock);
      attendanceBtn.addEventListener('click', launchAttendance);

      document.querySelectorAll('.grid-item button').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const action = btn.dataset.action;
          if(action==='settings') return openSettings();
          if(action==='info') return openInfo();
          if(action==='help') return openHelp();
          if(action==='dashboard') return openDashboard();
        });
      });

      modalClose.addEventListener('click', closeModal);
      modal.addEventListener('click', (e)=>{ if(e.target === modal) closeModal(); });
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && modal.classList.contains('show')) closeModal(); });

      themeToggle.addEventListener('click', ()=>{
        const current = document.documentElement.getAttribute('data-theme') || 'light';
        setTheme(current === 'dark' ? 'light' : 'dark');
      });

      window.addEventListener('online', setOfflineBanner);
      window.addEventListener('offline', setOfflineBanner);

      // Unlock audio on first user gesture (autoplay policy)
      const unlock = async () => {
        if (musicOn) await startMusic();
        document.removeEventListener('pointerdown', unlock);
        document.removeEventListener('keydown', unlock);
      };
      document.addEventListener('pointerdown', unlock, { once:true });
      document.addEventListener('keydown', unlock, { once:true });

      // Init
      setOfflineBanner();
      setTheme(getPreferredTheme());
      updateThemeIcon();
      applyTranslations();
      if (bgmEl) bgmEl.volume = 0.18;
      window.addEventListener('pageshow', ()=> hideLoading(), { once:true });
    })();
  </script>
</body>
</html>
