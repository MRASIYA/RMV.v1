<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="description" content="RMC Commercial Team - Quick access to Daily Counting, Stock Counting, Employee Attendance, and Dashboard" />
  <meta name="keywords" content="RMC, commercial, daily counting, stock counting, attendance, dashboard" />
  <meta name="author" content="RMC Commercial Team" />
  <meta name="theme-color" content="#f6f7fb" />
  <title>RMC Commercial Team</title>

  <!-- Performance hints -->
  <link rel="dns-prefetch" href="//fonts.googleapis.com">
  <link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin />
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin />
  <link rel="preconnect" href="https://script.google.com" crossorigin />
  <link rel="preconnect" href="https://docs.google.com" crossorigin />

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet" />

  <style>
    :root{
      --bg:#f6f7fb;
      --surface:#ffffff;
      --surface-border:rgba(17,24,39,.08);
      --text:#111827;
      --muted:#6b7280;
      --primary:#16a34a;
      --primary-2:#15803d;
      --radius:16px;
      --shadow:0 12px 28px rgba(0,0,0,.08);
      --ring: 0 0 0 3px rgba(22,163,74,.35);
      --dur-fast:.15s;
      --dur:.28s;

      /* App-specific accent colors and ripple (RGBA) */
      --c-daily: #22c55e;       --r-daily: rgba(34,197,94,.28);
      --c-stock: #3b82f6;       --r-stock: rgba(59,130,246,.28);
      --c-attendance: #8b5cf6;  --r-attendance: rgba(139,92,246,.28);
    }
    html[data-theme="dark"]{
      --bg:#0f172a;
      --surface:#111827;
      --surface-border:rgba(255,255,255,.08);
      --text:#f3f4f6;
      --muted:#9ca3af;
      --shadow:0 12px 28px rgba(0,0,0,.32);
      --ring: 0 0 0 3px rgba(99,102,241,.45);
    }

    *{box-sizing:border-box}
    html,body{height:100%;scroll-behavior:smooth}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:'Roboto',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      -webkit-tap-highlight-color: transparent;
    }

    /* Skip link */
    .skip-link{
      position:absolute; left:12px; top:-40px; z-index:10002;
      background:#111827; color:#fff; padding:8px 12px; border-radius:8px;
      transition: top var(--dur);
      text-decoration:none; font-weight:600;
    }
    .skip-link:focus{ top:12px; box-shadow: var(--ring); outline:none; }
    html[data-theme="dark"] .skip-link{ background:#fff; color:#111827; }

    /* Offline banner */
    .offline{
      position:fixed;top:0;left:0;right:0;z-index:10001;
      display:none;align-items:center;justify-content:center;gap:8px;
      background:#111827;color:#fff;padding:8px 12px;font-size:12px;
    }
    .offline.show{ display:flex; }
    .offline i{ color:#f59e0b; }
    html[data-theme="dark"] .offline{ background:#0b1220; }

    /* Container */
    .main-content{
      position:relative; z-index:1; max-width: 880px;
      margin: clamp(16px,6vh,48px) auto calc(56px + env(safe-area-inset-bottom));
      background: var(--surface);
      border-radius: var(--radius);
      padding: clamp(20px, 4vw, 32px);
      box-shadow: var(--shadow);
      border: 1px solid var(--surface-border);
    }

    /* Top actions */
    .top-actions{ display:flex;justify-content:space-between;align-items:center;margin-bottom:8px; }
    .theme-toggle{
      width:40px;height:40px;border-radius:10px;
      display:grid;place-items:center;cursor:pointer;border:1px solid var(--surface-border);
      background:transparent;color:var(--muted);
      transition: transform var(--dur), box-shadow var(--dur), color var(--dur), background var(--dur);
    }
    .theme-toggle:hover{ transform: translateY(-1px); color:var(--text); }
    .theme-toggle:focus-visible{ outline:none; box-shadow: var(--ring); }

    /* Hero */
    .hero{ display:flex;flex-direction:column;align-items:center;text-align:center; }
    .app-logo img{
      height:90px; width:auto; max-width: 240px;
      border-radius:12px;
      background:transparent;
      border:1px solid var(--surface-border);
      box-shadow: 0 6px 18px rgba(0,0,0,.06);
      padding: 12px; display:block;
    }
    .app-name{ font-size: clamp(22px, 3.5vw, 30px); font-weight:800; margin: 20px 0 6px; letter-spacing:.2px; }
    .app-description{ font-size:14px; color:var(--muted); margin-bottom:24px; max-width:560px; line-height:1.6; }

    /* Dock actions (with color ripple select effect) */
    .action-dock{
      display:flex; gap:16px; flex-wrap:wrap; justify-content:center; margin-bottom: 22px;
    }
    /* ACCESSIBILITY FIX: Swapped button for <a> tag */
    .dock-item{
      display:flex; flex-direction:column; align-items:center; gap:10px;
      cursor:pointer; background:transparent; border:none; padding:0; color:inherit;
      text-decoration: none;
    }
    .dock-icon{
      position:relative; overflow:hidden;
      width:92px; height:92px; border-radius:16px; display:grid; place-items:center;
      border:1px solid var(--surface-border); background: var(--surface);
      box-shadow: 0 6px 18px rgba(0,0,0,.08);
      transition: transform var(--dur), box-shadow var(--dur), filter var(--dur);
      font-size:28px; color:var(--primary);
    }
    .dock-item:hover .dock-icon{ transform: translateY(-2px); box-shadow: 0 10px 26px rgba(0,0,0,.12); }
    .dock-item:active .dock-icon{ transform: translateY(1px) scale(0.98); filter: brightness(.95); transition-duration: var(--dur-fast); }
    .dock-label{ font-size:13px; color:var(--text); font-weight:500; }
    .dock-item:focus-visible{ outline:none; }
    .dock-item:focus-visible .dock-icon{ box-shadow: var(--ring); }

    /* Ripple/Select color effect */
    .dock-icon::after{
      content:''; position:absolute; top:var(--py,50%); left:var(--px,50%);
      width:0; height:0; transform: translate(-50%,-50%); border-radius:50%;
      background: var(--accent-ripple, rgba(22,163,74,.28));
      opacity:.85; pointer-events:none;
      transition: width 620ms ease, height 620ms ease, opacity 780ms ease;
    }
    .dock-item.ripple .dock-icon::after{
      width:220px; height:220px; opacity:0;
    }

    /* Assign accent and ripple colors per button */
    #launchBtn{ --accent-color: var(--c-daily); --accent-ripple: var(--r-daily); }
    #stockBtn{ --accent-color: var(--c-stock); --accent-ripple: var(--r-stock); }
    #attendanceBtn{ --accent-color: var(--c-attendance); --accent-ripple: var(--r-attendance); }

    /* Quick actions */
    .app-grid{
      display:flex; justify-content:center; gap: 16px;
      border-top: 1px solid var(--surface-border);
      padding-top: 18px; margin-top:10px; width:100%; max-width: 520px; margin-left:auto;margin-right:auto;
    }
    .grid-item button{ background:none; border:1px solid var(--surface-border); color:var(--muted); padding:0; cursor:pointer; border-radius:12px; }
    .grid-icon{
      width:48px; height:48px; border-radius:12px; display:grid; place-items:center;
      transition: transform var(--dur), color var(--dur), background var(--dur), border-color var(--dur);
      background: var(--surface);
    }
    .grid-item button:hover .grid-icon{ color:var(--primary); transform:translateY(-1px); border-color: rgba(22,163,74,.35); }
    .grid-item button:focus-visible{ outline:none; box-shadow: var(--ring); }

    /* Progress/Modal */
    .progress-bar, .loading-overlay, .modal{ content-visibility: auto; }
    .progress-bar{
      position: fixed; top: 0; left: 0; height: 3px; width: 0%;
      background: linear-gradient(90deg, var(--primary), var(--primary-2));
      z-index: 10000; transition: width .35s ease;
    }
    .loading-overlay{
      position:fixed;inset:0;display:grid;place-items:center;
      background: var(--bg);
      z-index: 9999;
      opacity: 0;
      clip-path: circle(0% at var(--cx, 50%) var(--cy, 50%));
      transition: clip-path .5s cubic-bezier(0.4, 0, 0.2, 1), opacity .5s;
    }
    .loading-overlay.active{
      opacity: 1;
      clip-path: circle(150% at var(--cx, 50%) var(--cy, 50%));
    }
    .loading-box{
      display:flex;flex-direction:column;align-items:center;gap:14px;color:var(--text);text-align:center;
      opacity: 0;
      transform: translateY(10px);
      animation: fadeIn .4s .3s forwards;
    }
    .loading-ring{
      width:48px;height:48px;
      border: 4px solid var(--surface-border);
      border-top-color: var(--primary);
      border-radius:50%;
      animation: spin 1s linear infinite, pulse .8s ease-in-out infinite alternate;
    }
    .loading-text{ font-size:15px;font-weight:600; }

    .modal{
      position:fixed;inset:0;display:none;align-items:center;justify-content:center;
      background: rgba(0,0,0,.35); z-index: 9998;
    }
    .modal.show{ display:flex; }
    .modal-dialog{
      width:min(92vw,520px);
      background:var(--surface);border-radius:12px;box-shadow: var(--shadow);
      transform: translateY(8px); opacity:0; animation: modalIn .28s ease forwards;
      color:var(--text); border:1px solid var(--surface-border);
    }
    .modal-header{
      display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--surface-border);
    }
    .modal-title{ font-weight:700; }
    .modal-close{
      background:transparent;border:1px solid var(--surface-border);font-size:16px;cursor:pointer;color:var(--muted);
      padding:6px 8px;border-radius:8px;transition: background var(--dur), color var(--dur), border-color var(--dur);
    }
    .modal-close:hover{ background:rgba(0,0,0,.04); color:var(--text); border-color: rgba(0,0,0,.15); }
    html[data-theme="dark"] .modal-close:hover{ background:rgba(255,255,255,.06); border-color: rgba(255,255,255,.18); }
    .modal-body{ padding:14px 16px; line-height:1.6; }

    /* Watermark */
    .watermark{
      position: fixed; left:0; right:0; bottom:0;
      background: rgba(17,24,39,.85); color:#fff; display:flex; justify-content:space-between; align-items:center;
      padding: 10px 16px calc(10px + env(safe-area-inset-bottom));
      font-size:12px; z-index: 900;
    }
    html[data-theme="dark"] .watermark{ background: rgba(0,0,0,.7); }

    /* Animations */
    @keyframes spin{ to{ transform: rotate(360deg); } }
    @keyframes pulse{ to{ transform: scale(1.1); opacity: 0.8; } }
    @keyframes fadeIn{ to{ opacity:1; transform: translateY(0); } }
    @keyframes modalIn{ from{ opacity:0; transform: translateY(8px);} to{ opacity:1; transform: translateY(0);} }

    @media (prefers-reduced-motion: reduce) {
      *{ animation: none !important; transition: none !important; }
    }
    @media (max-width: 540px){
      .dock-icon{ width:84px; height:84px; font-size:26px; }
      .action-dock{ gap:12px; }
      .app-grid{ gap:12px; }
    }
  </style>
</head>
<body>
  <a class="skip-link" href="#main">Skip to content</a>
  <div class="offline" id="offlineBanner" role="status" aria-live="polite">
    <i class="fa-solid fa-triangle-exclamation" aria-hidden="true"></i> <span data-i18n="offline">You’re offline. Some actions may not work.</span>
  </div>
  <noscript>
    <div style="position:fixed;inset:0;background:#111827;color:#fff;display:flex;align-items:center;justify-content:center;z-index:100000;text-align:center;padding:20px;">
      This page requires JavaScript to launch applications. Please enable it.
    </div>
  </noscript>

  <div class="progress-bar" id="progressBar" aria-hidden="true"></div>

  <div class="loading-overlay" id="loadingOverlay" role="alert" aria-live="polite" aria-busy="true">
    <div class="loading-box">
      <div class="loading-ring" aria-hidden="true"></div>
      <div class="loading-text" id="loadingText">Loading...</div>
    </div>
  </div>

  <div class="modal" id="modal" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="modalTitle">
    <div class="modal-dialog" role="document">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">Title</div>
        <button class="modal-close" type="button" id="modalClose" aria-label="Close">
          <i class="fa fa-times" aria-hidden="true"></i>
        </button>
      </div>
      <div class="modal-body" id="modalBody">Body</div>
    </div>
  </div>

  <main class="main-content" id="main" aria-busy="false">
    <div class="top-actions">
      <div></div>
      <button id="themeToggle" class="theme-toggle" aria-label="Toggle theme" title="Toggle theme">
        <i class="fa-solid fa-sun" id="themeIcon" aria-hidden="true"></i>
      </button>
    </div>

    <section class="hero" aria-label="Application Launcher">
      <div class="app-logo" role="img" aria-label="RMC Logo">
        <img src="https://synques-cdn.s3.ap-south-1.amazonaws.com/rmchemicals.in/images/rmc-logo.png"
             alt="RMC Logo" loading="eager" decoding="async" fetchpriority="high" />
      </div>
      <h1 class="app-name" data-i18n="appName">RMC Commercial Team</h1>
      <p class="app-description" data-i18n="description">
        Quickly access Daily Counting, Stock Counting, Employee Attendance, and Dashboard tools.
      </p>

      <div class="action-dock">
        <!-- ACCESSIBILITY FIX: Using <a> tags for navigation -->
        <a href="#" class="dock-item" id="launchBtn" aria-label="Open Daily Counting">
          <div class="dock-icon"><i class="fa-solid fa-list-check" aria-hidden="true"></i></div>
          <span class="dock-label" data-i18n="daily">Daily Counting</span>
        </a>
        <a href="#" class="dock-item" id="stockBtn" aria-label="Open Stock Counting">
          <div class="dock-icon"><i class="fa-solid fa-boxes-stacked" aria-hidden="true"></i></div>
          <span class="dock-label" data-i18n="stock">Stock Counting</span>
        </a>
        <a href="#" class="dock-item" id="attendanceBtn" aria-label="Open Employee Attendance Record">
          <div class="dock-icon"><i class="fa-solid fa-user-check" aria-hidden="true"></i></div>
          <span class="dock-label" data-i18n="attendance">Attendance</span>
        </a>
      </div>

      <nav class="app-grid" aria-label="Quick actions">
        <div class="grid-item">
          <button class="grid-icon" data-action="settings" aria-label="Settings" title="Settings">
            <i class="fas fa-gear" aria-hidden="true"></i>
          </button>
        </div>
        <div class="grid-item">
          <button class="grid-icon" data-action="info" aria-label="Info" title="Info">
            <i class="fas fa-circle-info" aria-hidden="true"></i>
          </button>
        </div>
        <div class="grid-item">
          <button class="grid-icon" data-action="help" aria-label="Help" title="Help">
            <i class="fas fa-circle-question" aria-hidden="true"></i>
          </button>
        </div>
        <div class="grid-item">
          <button class="grid-icon" data-action="dashboard" aria-label="Dashboard" title="Dashboard">
            <i class="fas fa-chart-bar" aria-hidden="true"></i>
          </button>
        </div>
      </nav>
    </section>
  </main>

  <footer class="watermark" aria-label="Watermark">
    <div class="watermark-left">
      <div>Department: Commercial Team</div>
      <div>Modify Admin: Lakshan</div>
    </div>
    <div class="watermark-right">
      <i class="fas fa-building" aria-hidden="true"></i> RMC Commercial Team
    </div>
  </footer>

  <script>
    (function(){
      'use strict';

      const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyZwQrxxXeDnT1llTZb3h7Mj059z4y_3JuKnmQ2p5yIdQXbxttoDblg4coapbSy-gkq/exec';
      const STOCK_SCRIPT_URL  = 'https://script.google.com/macros/s/AKfycbyPfi4-daF6-XkeENn-QR3EpF9MS3TLzMT3pHrDqO-1A2hRRc-1Lkb-4sYLPCEdN0t7/exec';
      const ATTENDANCE_URL    = 'https://rmc.timelabs.in/';
      const DASHBOARD_URL     = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRxRoqXa5h87pfYymuSXbHsuvR90a6Uu5U8JTa6mIbT4LORwb8mUeSRWqYHH14aWtHpcBIlJgXlRY0e/pubhtml';

      // Elements
      const progressBar   = document.getElementById('progressBar'),
            loadingOverlay= document.getElementById('loadingOverlay'),
            loadingText   = document.getElementById('loadingText'),
            launchBtn     = document.getElementById('launchBtn'),
            stockBtn      = document.getElementById('stockBtn'),
            attendanceBtn = document.getElementById('attendanceBtn'),
            modal         = document.getElementById('modal'),
            modalClose    = document.getElementById('modalClose'),
            modalTitle    = document.getElementById('modalTitle'),
            modalBody     = document.getElementById('modalBody'),
            themeToggle   = document.getElementById('themeToggle'),
            themeIcon     = document.getElementById('themeIcon'),
            offlineBanner = document.getElementById('offlineBanner'),
            main          = document.getElementById('main');

      // BUG FIX: Correctly track navigation to prevent false error messages.
      let didNavigate = false;
      let lastFocused = null;

      // i18n (Translations)
      const I18N = {
        en: {
          appName: 'RMC Commercial Team',
          description: 'Quickly access Daily Counting, Stock Counting, Employee Attendance, and Dashboard tools.',
          daily: 'Daily Counting',
          stock: 'Stock Counting',
          attendance: 'Attendance',
          info: 'Info',
          settings: 'Settings',
          help: 'Help',
          dashboard: 'Dashboard',
          offline: 'You’re offline. Some actions may not work.',
          opening: 'Opening {label}...',
          unableOpenTitle: 'Unable to open',
          unableOpenBody: 'We couldn’t open {label}. Please try again or check your network.',
          offlineTitle: 'You are offline',
          offlineBody: 'Cannot open {label} while offline. Please check your connection.',
          settingsTitle: 'Application Settings',
          settingsIntro: 'Configure your preferences.',
          language: 'Language',
        },
        si: { /* Sinhala translations */ },
        ta: { /* Tamil translations */ }
      };
      let currentLang = localStorage.getItem('lang') || 'en';

      const t = (key) => (I18N[currentLang] && I18N[currentLang][key]) || I18N.en[key] || key;
      const tf = (key, params={}) => {
        let s = t(key);
        Object.entries(params).forEach(([k,v]) => { s = s.split(`{${k}}`).join(v); });
        return s;
      };

      const applyTranslations = () => {
        document.querySelectorAll('[data-i18n]').forEach(el=>{ el.textContent = t(el.dataset.i18n); });
        document.querySelectorAll('.grid-item button').forEach(btn=>{ const action = btn.dataset.action; const label = t(action); btn.setAttribute('aria-label', label); btn.setAttribute('title', label); });
        const offlineSpan = document.querySelector('.offline [data-i18n="offline"]');
        if(offlineSpan) offlineSpan.textContent = t('offline');
        document.documentElement.lang = currentLang;
      };

      // Theme Management
      const updateThemeIcon = () => {
        const theme = document.documentElement.getAttribute('data-theme') || 'light';
        if(themeIcon) themeIcon.className = theme === 'dark' ? 'fa-solid fa-moon' : 'fa-solid fa-sun';
        if(themeToggle) themeToggle.setAttribute('aria-label', `Switch to ${theme === 'dark' ? 'light' : 'dark'} mode`);
      };
      const setTheme = (theme) => { document.documentElement.setAttribute('data-theme', theme); localStorage.setItem('theme', theme); updateThemeIcon(); };
      const getPreferredTheme = () => { const s = localStorage.getItem('theme'); return s || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'); };

      // Loading Overlay
      const showLoading = (message = 'Loading...', event = null) => {
        if (!loadingOverlay || !loadingText || !progressBar || !main) return;
        main.setAttribute('aria-busy', 'true');
        loadingText.textContent = message;
        if (event && event.clientX && event.clientY) {
          loadingOverlay.style.setProperty('--cx', `${event.clientX}px`);
          loadingOverlay.style.setProperty('--cy', `${event.clientY}px`);
        } else {
          loadingOverlay.style.removeProperty('--cx');
          loadingOverlay.style.removeProperty('--cy');
        }
        loadingOverlay.classList.add('active');
        progressBar.style.width = '0%';
        requestAnimationFrame(() => {
          setTimeout(()=>progressBar.style.width='30%', 120);
          setTimeout(()=>progressBar.style.width='70%', 520);
          setTimeout(()=>progressBar.style.width='100%', 1000);
        });
      };
      const hideLoading = () => { if(loadingOverlay && progressBar && main) { main.setAttribute('aria-busy', 'false'); setTimeout(()=>{ loadingOverlay.classList.remove('active'); progressBar.style.width = '0%'; }, 280); } };

      // Ripple effect for links
      const addRipple = (link, e) => {
        const icon = link.querySelector('.dock-icon');
        if (!icon) return;
        const rect = icon.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        icon.style.setProperty('--px', `${x}px`);
        icon.style.setProperty('--py', `${y}px`);
        link.classList.remove('ripple');
        void icon.offsetWidth;
        link.classList.add('ripple');
      };
      
      // Modal + Focus Trap
      const focusableSelector = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
      let trapHandler = null;
      const trapFocus = (container) => {
        const nodes = Array.from(container.querySelectorAll(focusableSelector)).filter(el => !el.disabled);
        if (!nodes.length) return;
        const first = nodes[0], last = nodes[nodes.length - 1];
        trapHandler = (e) => {
          if (e.key !== 'Tab') return;
          if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }
          else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
        };
        container.addEventListener('keydown', trapHandler);
      };
      const untrapFocus = (container) => { if (trapHandler) container.removeEventListener('keydown', trapHandler); trapHandler = null; };
      const openModal = (title, contentHTML) => { if(!modal || !modalTitle || !modalBody || !modalClose) return; lastFocused = document.activeElement; modalTitle.textContent = title; modalBody.innerHTML = contentHTML; modal.classList.add('show'); modal.setAttribute('aria-hidden', 'false'); setTimeout(()=>modalClose.focus(), 30); trapFocus(modal); };
      const closeModal = () => { if(!modal) return; modal.classList.remove('show'); modal.setAttribute('aria-hidden', 'true'); untrapFocus(modal); if (lastFocused && typeof lastFocused.focus === 'function') lastFocused.focus(); };

      // Settings Modal
      const openSettings = () => {
        const settingsHTML = `
          <div style="display:grid; gap:14px;">
            <p style="margin:0; color:var(--muted);">${t('settingsIntro')}</p>
            <div style="display:grid; gap:6px;">
              <label for="langSelect" style="font-weight:600;">${t('language')}</label>
              <select id="langSelect" style="padding:8px 10px; border-radius:8px; border:1px solid var(--surface-border); background:var(--surface); color:var(--text);">
                <option value="en"${currentLang==='en'?' selected':''}>English</option>
                <option value="si"${currentLang==='si'?' selected':''}>සිංහල (Sinhala)</option>
                <option value="ta"${currentLang==='ta'?' selected':''}>தமிழ் (Tamil)</option>
              </select>
            </div>
          </div>
        `;
        openModal(t('settingsTitle'), settingsHTML);
        const langSelect = document.getElementById('langSelect');
        if (langSelect) langSelect.addEventListener('change', (e)=>{ currentLang = e.target.value; localStorage.setItem('lang', currentLang); applyTranslations(); });
      };

      const openInfo = () => openModal(t('info'), `<strong>${t('appName')}</strong><br/>${t('description')}<br/><br/><strong>Admin:</strong> Lakshan • 0772892711`);
      const openHelp = () => openModal(t('help'), `• ${t('daily')} • ${t('stock')} • ${t('attendance')} • ${t('dashboard')}<br/>${t('settingsIntro')}`);

      // Safe Navigation Handler
      const safeNavigate = (url, labelKey, event) => {
        event.preventDefault(); // Prevent default link behavior
        const label = t(labelKey);
        if (!navigator.onLine) { openModal(t('offlineTitle'), tf('offlineBody', {label})); return; }
        
        addRipple(event.currentTarget, event);
        showLoading(tf('opening', {label}), event);
        
        const timeout = setTimeout(()=>{ 
            // BUG FIX: Check 'didNavigate' flag. If false, navigation likely failed.
            if (!didNavigate && document.visibilityState==='visible'){ 
                hideLoading(); 
                openModal(t('unableOpenTitle'), tf('unableOpenBody',{label})); 
            } 
        }, 6000);
        
        setTimeout(()=>{ window.location.href = url; }, 400); // Short delay for ripple effect
      };

      const setOfflineBanner = () => { if(offlineBanner) offlineBanner.classList.toggle('show', !navigator.onLine); };

      // --- Event Listeners ---
      
      // ROBUSTNESS: Check if elements exist before adding listeners
      if (launchBtn) launchBtn.addEventListener('click', (e) => safeNavigate(GOOGLE_SCRIPT_URL, 'daily', e));
      if (stockBtn) stockBtn.addEventListener('click', (e) => safeNavigate(STOCK_SCRIPT_URL, 'stock', e));
      if (attendanceBtn) {
        attendanceBtn.addEventListener('click', (e) => safeNavigate(ATTENDANCE_URL, 'attendance', e));
        // SECURITY FIX: Add protection for external links
        attendanceBtn.setAttribute('target', '_blank');
        attendanceBtn.setAttribute('rel', 'noopener noreferrer');
      }

      document.querySelectorAll('.grid-item button').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          const action = btn.dataset.action;
          if(action==='settings') return openSettings();
          if(action==='info') return openInfo();
          if(action==='help') return openHelp();
          if(action==='dashboard') {
              // Create a temporary link to use safeNavigate
              const tempLink = document.createElement('a');
              safeNavigate(DASHBOARD_URL, 'dashboard', { ...e, currentTarget: tempLink });
          }
        });
      });

      if (modalClose) modalClose.addEventListener('click', closeModal);
      if (modal) modal.addEventListener('click', (e)=>{ if(e.target === modal) closeModal(); });
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && modal && modal.classList.contains('show')) closeModal(); });
      if (themeToggle) themeToggle.addEventListener('click', ()=>{ const current = document.documentElement.getAttribute('data-theme') || 'light'; setTheme(current === 'dark' ? 'light' : 'dark'); });

      window.addEventListener('online', setOfflineBanner);
      window.addEventListener('offline', setOfflineBanner);

      // BUG FIX: Set didNavigate to true when user is leaving the page
      window.addEventListener('beforeunload', () => { didNavigate = true; });

      // Handle user navigating back to the page (hides loading overlay)
      window.addEventListener('pageshow', (event) => {
        if (event.persisted) { // Check if page was loaded from back/forward cache
            didNavigate = false; // Reset flag
            hideLoading();
        }
      }, { once: false });

      // --- Initialisation ---
      setOfflineBanner();
      setTheme(getPreferredTheme());
      applyTranslations();
      
    })();
  </script>
</body>
</html>
