<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="description" content="RMC Commercial Team - Quick access to Daily Counting, Stock Counting, Employee Attendance, and Dashboard" />
  <meta name="keywords" content="RMC, commercial, daily counting, stock counting, attendance, dashboard" />
  <meta name="author" content="RMC Commercial Team" />
  <meta name="theme-color" content="#f6f7fb" />
  <title>RMC Commercial Team</title>

  <!-- Performance hints -->
  <link rel="dns-prefetch" href="//fonts.googleapis.com">
  <link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin />
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin />
  <link rel="preconnect" href="https://script.google.com" crossorigin />
  <link rel="preconnect" href="https://docs.google.com" crossorigin />
  <link rel="preconnect" href="https://cdn.pixabay.com" crossorigin />

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet" />

  <style>
    :root{
      --bg:#f6f7fb;
      --surface:#ffffff;
      --surface-border:rgba(17,24,39,.08);
      --text:#111827;
      --muted:#6b7280;
      --primary:#16a34a;
      --primary-2:#15803d;
      --radius:16px;
      --shadow:0 12px 28px rgba(0,0,0,.08);
      --ring: 0 0 0 3px rgba(22,163,74,.35);
      --dur-fast:.15s;
      --dur:.28s;

      /* Layout control */
      --page-pad: 16px;
      --footer-h: 64px;   /* synced via JS */
      --offline-h: 0px;   /* synced via JS */

      /* App-specific accent colors and ripple (RGBA) */
      --c-daily: #22c55e;       --r-daily: rgba(34,197,94,.28);
      --c-stock: #3b82f6;       --r-stock: rgba(59,130,246,.28);
      --c-attendance: #8b5cf6;  --r-attendance: rgba(139,92,246,.28);
    }
    html[data-theme="dark"]{
      --bg:#0f172a;
      --surface:#111827;
      --surface-border:rgba(255,255,255,.08);
      --text:#f3f4f6;
      --muted:#9ca3af;
      --shadow:0 12px 28px rgba(0,0,0,.32);
      --ring: 0 0 0 3px rgba(99,102,241,.45);
    }

    *{box-sizing:border-box}

    /* Lock page and center app */
    html, body { height: 100%; }
    body{
      margin:0;
      display: grid;
      place-items: center;
      background:var(--bg);
      color:var(--text);
      font-family:'Roboto',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      -webkit-tap-highlight-color: transparent;
      overflow: hidden; /* no page scroll */
      padding: var(--page-pad);
      padding-top: calc(var(--page-pad) + var(--offline-h)); /* prevent overlap with banner */
      padding-bottom: calc(var(--page-pad) + var(--footer-h) + env(safe-area-inset-bottom));
      padding-left: max(var(--page-pad), env(safe-area-inset-left));
      padding-right: max(var(--page-pad), env(safe-area-inset-right));
    }

    /* Skip link */
    .skip-link{
      position:absolute; left:12px; top:-44px; z-index:10002;
      background:#111827; color:#fff; padding:8px 12px; border-radius:8px;
      transition: top var(--dur);
      text-decoration:none; font-weight:600;
    }
    .skip-link:focus{ top:12px; box-shadow: var(--ring); outline:none; }
    html[data-theme="dark"] .skip-link{ background:#fff; color:#111827; }

    /* Offline banner */
    .offline{
      position:fixed;top:0;left:0;right:0;z-index:10001;
      display:none;align-items:center;justify-content:center;gap:8px;
      background:#111827;color:#fff;padding:8px 12px;font-size:12px;
    }
    .offline.show{ display:flex; }
    .offline i{ color:#f59e0b; }
    html[data-theme="dark"] .offline{ background:#0b1220; }

    /* Container */
    .main-content{
      position:relative; z-index:1; width: 100%;
      max-width: 880px;
      background: var(--surface);
      border-radius: var(--radius);
      padding: clamp(16px, 4vw, 28px);
      box-shadow: var(--shadow);
      border: 1px solid var(--surface-border);
      overflow: auto; /* internal scroll on very small screens */
      max-height: calc(100vh - var(--footer-h) - var(--offline-h) - 2*var(--page-pad));
    }
    @supports (height: 100dvh) {
      .main-content{ max-height: calc(100dvh - var(--footer-h) - var(--offline-h) - 2*var(--page-pad)); }
    }

    /* Top actions */
    .top-actions{ display:flex;justify-content:space-between;align-items:center;margin-bottom:8px; }
    .theme-toggle{
      width:40px;height:40px;border-radius:10px;
      display:grid;place-items:center;cursor:pointer;border:1px solid var(--surface-border);
      background:transparent;color:var(--muted);
      transition: transform var(--dur), box-shadow var(--dur), color var(--dur), background var(--dur);
    }
    .theme-toggle:hover{ transform: translateY(-1px); color:var(--text); }
    .theme-toggle:focus-visible{ outline:none; box-shadow: var(--ring); }

    /* Hero */
    .hero{ display:flex;flex-direction:column;align-items:center;text-align:center; }
    .app-logo img{
      height:90px; width:auto; max-width: 240px;
      border-radius:12px;
      background:transparent;
      border:1px solid var(--surface-border);
      box-shadow: 0 6px 18px rgba(0,0,0,.06);
      padding: 12px; display:block;
    }
    .app-name{ font-size: clamp(22px, 3.5vw, 30px); font-weight:800; margin: 20px 0 6px; letter-spacing:.2px; }
    .app-description{ font-size:14px; color:var(--muted); margin-bottom:24px; max-width:560px; line-height:1.6; }

    /* Dock actions (with ripple) */
    .action-dock{
      display:flex; gap:16px; flex-wrap:wrap; justify-content:center; margin-bottom: 22px;
    }
    .dock-item{
      display:flex; flex-direction:column; align-items:center; gap:10px;
      cursor:pointer; background:transparent; border:none; padding:0; color:inherit; font-family: inherit;
    }
    .dock-icon{
      position:relative; overflow:hidden;
      width:92px; height:92px; border-radius:16px; display:grid; place-items:center;
      border:1px solid var(--surface-border); background: var(--surface);
      box-shadow: 0 6px 18px rgba(0,0,0,.08);
      transition: transform var(--dur), box-shadow var(--dur), filter var(--dur);
      font-size:28px; color:var(--primary);
    }
    .dock-item:hover .dock-icon{ transform: translateY(-2px); box-shadow: 0 10px 26px rgba(0,0,0,.12); }
    .dock-item:active .dock-icon{ transform: translateY(1px) scale(0.98); filter: brightness(.95); transition-duration: var(--dur-fast); }
    .dock-label{ font-size:13px; color:var(--text); font-weight:500; }
    .dock-item:focus-visible{ outline:none; }
    .dock-item:focus-visible .dock-icon{ box-shadow: var(--ring); }

    .dock-icon::after{
      content:''; position:absolute; top:var(--py,50%); left:var(--px,50%);
      width:0; height:0; transform: translate(-50%,-50%); border-radius:50%;
      background: var(--accent-ripple, rgba(22,163,74,.28));
      opacity:.85; pointer-events:none;
      transition: width 620ms ease, height 620ms ease, opacity 780ms ease;
    }
    .dock-item.ripple .dock-icon::after{ width:220px; height:220px; opacity:0; }

    /* Assign accent and ripple colors per button */
    #launchBtn{ --accent-color: var(--c-daily); --accent-ripple: var(--r-daily); }
    #stockBtn{ --accent-color: var(--c-stock); --accent-ripple: var(--r-stock); }
    #attendanceBtn{ --accent-color: var(--c-attendance); --accent-ripple: var(--r-attendance); }

    /* Quick actions */
    .app-grid{
      display:flex; justify-content:center; gap: 16px;
      border-top: 1px solid var(--surface-border);
      padding-top: 18px; margin-top:10px; width:100%; max-width: 520px; margin-left:auto;margin-right:auto;
    }
    .grid-item button{ background:none; border:1px solid var(--surface-border); color:var(--muted); padding:0; cursor:pointer; border-radius:12px; }
    .grid-icon{
      width:48px; height:48px; border-radius:12px; display:grid; place-items:center;
      transition: transform var(--dur), color var(--dur), background var(--dur), border-color var(--dur);
      background: var(--surface);
    }
    .grid-item button:hover .grid-icon{ color:var(--primary); transform:translateY(-1px); border-color: rgba(22,163,74,.35); }
    .grid-item button:focus-visible{ outline:none; box-shadow: var(--ring); }

    /* Progress/Modal */
    .progress-bar{
      position: fixed; top: 0; left: 0; height: 3px; width: 0%;
      background: linear-gradient(90deg, var(--primary), var(--primary-2));
      z-index: 10000; transition: width .35s ease;
    }

    .loading-overlay{
      position:fixed;inset:0;display:grid;place-items:center;
      background: var(--bg);
      z-index: 9999;
      opacity: 0; visibility: hidden;
      clip-path: circle(0% at var(--cx, 50%) var(--cy, 50%));
      transition: clip-path .5s cubic-bezier(0.4, 0, 0.2, 1), opacity .5s, visibility 0s .5s;
    }
    .loading-overlay.active{ opacity: 1; visibility: visible; transition-delay: 0s; clip-path: circle(150% at var(--cx, 50%) var(--cy, 50%)); }
    .loading-box{ display:flex;flex-direction:column;align-items:center;gap:14px;color:var(--text);text-align:center; opacity: 0; transform: translateY(10px); animation: fadeIn .4s .3s forwards; }
    .loading-ring{ width:48px;height:48px; border: 4px solid var(--surface-border); border-top-color: var(--primary); border-radius:50%; animation: spin 1s linear infinite, pulse .8s ease-in-out infinite alternate; }
    .loading-text{ font-size:15px;font-weight:600; }

    .modal{
      position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
      background: rgba(0,0,0,.35); z-index: 9998;
      opacity: 0; visibility: hidden; transition: opacity var(--dur), visibility 0s var(--dur);
    }
    .modal.show{ opacity:1; visibility: visible; transition-delay: 0s; }
    .modal-dialog{ width:min(92vw,520px); background:var(--surface);border-radius:12px;box-shadow: var(--shadow); transform: scale(.96); opacity:0; transition: transform var(--dur), opacity var(--dur); border:1px solid var(--surface-border); }
    .modal.show .modal-dialog{ opacity:1; transform: scale(1); }
    .modal-header{ display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--surface-border); }
    .modal-title{ font-weight:700; font-size: 1.1rem; margin: 0; }
    .modal-close{
      background:transparent;border:1px solid var(--surface-border);font-size:16px;cursor:pointer;color:var(--muted);
      width: 32px; height: 32px; border-radius:8px; display: grid; place-items: center; padding: 0;
      transition: background var(--dur), color var(--dur), border-color var(--dur), transform var(--dur-fast);
    }
    .modal-close:hover{ background:rgba(0,0,0,.04); color:var(--text); border-color: rgba(0,0,0,.15); }
    .modal-close:active{ transform: scale(0.95); }
    .modal-close:focus-visible{ outline: none; box-shadow: var(--ring); }
    html[data-theme="dark"] .modal-close:hover{ background:rgba(255,255,255,.06); border-color: rgba(255,255,255,.18); }
    .modal-body{ padding:16px; line-height:1.6; }

    /* Settings controls */
    .modal-body select{
      width:100%; padding:8px 10px; border-radius:8px; font-size:14px;
      border:1px solid var(--surface-border); background:var(--bg); color:var(--text);
      -webkit-appearance: none; appearance: none;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
      background-position: right .5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem;
    }
    .switch{position:relative;display:inline-block;width:44px;height:24px}
    .switch input{opacity:0;width:0;height:0}
    .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:var(--surface-border);transition:var(--dur);border-radius:24px}
    .slider:before{position:absolute;content:"";height:18px;width:18px;left:3px;bottom:3px;background-color:var(--surface);transition:var(--dur);border-radius:50%}
    input:checked+.slider{background-color:var(--primary)}
    input:focus-visible+.slider, .modal-body select:focus-visible{box-shadow:var(--ring); outline:none;}
    input:checked+.slider:before{transform:translateX(20px)}

    /* Watermark */
    .watermark{
      position: fixed; left:0; right:0; bottom:0;
      background: rgba(17,24,39,.85); color:#fff; display:flex; justify-content:space-between; align-items:center;
      padding: 10px 16px calc(10px + env(safe-area-inset-bottom));
      font-size:12px; z-index: 900;
    }
    html[data-theme="dark"] .watermark{ background: rgba(0,0,0,.7); }

    /* Animations */
    @keyframes spin{ to{ transform: rotate(360deg); } }
    @keyframes pulse{ to{ transform: scale(1.1); opacity: 0.8; } }
    @keyframes fadeIn{ to{ opacity:1; transform: translateY(0); } }

    @media (prefers-reduced-motion: reduce) { *{ animation: none !important; transition: none !important; } }
    @media (max-width: 540px){
      .dock-icon{ width:84px; height:84px; font-size:26px; }
      .action-dock{ gap:12px; }
      .app-grid{ gap:12px; }
    }
  </style>
</head>
<body>
  <a class="skip-link" href="#main">Skip to content</a>

  <div class="offline" id="offlineBanner" role="status" aria-live="polite">
    <i class="fa-solid fa-triangle-exclamation" aria-hidden="true"></i>
    <span data-i18n="offline">You’re offline. Some actions may not work.</span>
  </div>

  <noscript>
    <div style="position:fixed;inset:0;background:#111827;color:#fff;display:flex;align-items:center;justify-content:center;z-index:100000;text-align:center;padding:20px;">
      This page requires JavaScript to launch applications. Please enable it.
    </div>
  </noscript>

  <!-- Relaxing BGM with robust fallback chain -->
  <audio
    id="bgm"
    preload="auto"
    loop
    crossorigin="anonymous"
    playsinline
    data-srcs="assets/bgm-relax.mp3|assets/bgm.mp3|https://cdn.pixabay.com/download/audio/2021/10/26/audio_2f4d9c74f8.mp3?filename=relaxing-ambient-108163.mp3">
  </audio>

  <div class="progress-bar" id="progressBar" aria-hidden="true"></div>

  <div class="loading-overlay" id="loadingOverlay" role="alert" aria-live="polite" aria-busy="true">
    <div class="loading-box">
      <div class="loading-ring" aria-hidden="true"></div>
      <div class="loading-text" id="loadingText">Loading...</div>
    </div>
  </div>

  <div class="modal" id="modal" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="modalTitle">
    <div class="modal-dialog" role="document">
      <div class="modal-header">
        <h2 class="modal-title" id="modalTitle">Title</h2>
        <button class="modal-close" type="button" id="modalClose" aria-label="Close">
          <i class="fa fa-times" aria-hidden="true"></i>
        </button>
      </div>
      <div class="modal-body" id="modalBody">Body</div>
    </div>
  </div>

  <main class="main-content" id="main" aria-busy="false">
    <div class="top-actions">
      <div></div>
      <button id="themeToggle" class="theme-toggle" aria-label="Toggle theme" title="Toggle theme">
        <i class="fa-solid fa-sun" id="themeIcon"></i>
      </button>
    </div>

    <section class="hero" aria-label="Application Launcher">
      <div class="app-logo" role="img" aria-label="RMC Logo">
        <img src="https://synques-cdn.s3.ap-south-1.amazonaws.com/rmchemicals.in/images/rmc-logo.png"
             alt="RMC Logo" loading="eager" decoding="async" fetchpriority="high" />
      </div>
      <h1 class="app-name" data-i18n="appName">RMC Commercial Team</h1>
      <p class="app-description" data-i18n="description">
        Quickly access Daily Counting, Stock Counting, Employee Attendance, and Dashboard tools.
      </p>

      <div class="action-dock">
        <button class="dock-item" id="launchBtn" aria-label="Open Daily Counting">
          <div class="dock-icon"><i class="fa-solid fa-list-check" aria-hidden="true"></i></div>
          <span class="dock-label" data-i18n="daily">Daily Counting</span>
        </button>
        <button class="dock-item" id="stockBtn" aria-label="Open Stock Counting">
          <div class="dock-icon"><i class="fa-solid fa-boxes-stacked" aria-hidden="true"></i></div>
          <span class="dock-label" data-i18n="stock">Stock Counting</span>
        </button>
        <button class="dock-item" id="attendanceBtn" aria-label="Open Employee Attendance Record">
          <div class="dock-icon"><i class="fa-solid fa-user-check" aria-hidden="true"></i></div>
          <span class="dock-label" data-i18n="attendance">Attendance</span>
        </button>
      </div>

      <nav class="app-grid" aria-label="Quick actions">
        <div class="grid-item">
          <button class="grid-icon" data-action="settings" aria-label="Settings" title="Settings">
            <i class="fas fa-gear" aria-hidden="true"></i>
          </button>
        </div>
        <div class="grid-item">
          <button class="grid-icon" data-action="info" aria-label="Info" title="Info">
            <i class="fas fa-circle-info" aria-hidden="true"></i>
          </button>
        </div>
        <div class="grid-item">
          <button class="grid-icon" data-action="help" aria-label="Help" title="Help">
            <i class="fas fa-circle-question" aria-hidden="true"></i>
          </button>
        </div>
        <div class="grid-item">
          <button class="grid-icon" data-action="dashboard" aria-label="Dashboard" title="Dashboard">
            <i class="fas fa-chart-bar" aria-hidden="true"></i>
          </button>
        </div>
      </nav>
    </section>
  </main>

  <footer class="watermark" aria-label="Watermark" id="watermark">
    <div class="watermark-left">
      <div>Department: Commercial Team</div>
      <div>Modify Admin: Lakshan</div>
    </div>
    <div class="watermark-right">
      <i class="fas fa-building" aria-hidden="true"></i> RMC Commercial Team
    </div>
  </footer>

  <script>
    (function(){
      'use strict';

      // --- CONFIGURATION ---
      const URLS = {
        DAILY: 'https://script.google.com/macros/s/AKfycbyZwQrxxXeDnT1llTZb3h7Mj059z4y_3JuKnmQ2p5yIdQXbxttoDblg4coapbSy-gkq/exec',
        STOCK: 'https://script.google.com/macros/s/AKfycbw2y8_iQo-PJsgzlB5j63Lc5b9YU0Twc0b984cHsgfuzndL2B5PLvgPYxtlPJg1D1zQ/exec',
        ATTENDANCE: 'https://rmc.timelabs.in/',
        DASHBOARD: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRxRoqXa5h87pfYymuSXbHsuvR90a6Uu5U8JTa6mIbT4LORwb8mUeSRWqYHH14aWtHpcBIlJgXlRY0e/pubhtml',
      };

      // --- DOM ELEMENTS ---
      const el = {
        progressBar: document.getElementById('progressBar'),
        loadingOverlay: document.getElementById('loadingOverlay'),
        loadingText: document.getElementById('loadingText'),
        launchBtn: document.getElementById('launchBtn'),
        stockBtn: document.getElementById('stockBtn'),
        attendanceBtn: document.getElementById('attendanceBtn'),
        modal: document.getElementById('modal'),
        modalClose: document.getElementById('modalClose'),
        modalTitle: document.getElementById('modalTitle'),
        modalBody: document.getElementById('modalBody'),
        themeToggle: document.getElementById('themeToggle'),
        themeIcon: document.getElementById('themeIcon'),
        offlineBanner: document.getElementById('offlineBanner'),
        watermark: document.getElementById('watermark'),
        main: document.getElementById('main'),
        bgm: document.getElementById('bgm'),
      };

      // --- STATE ---
      const state = {
        lastFocused: null,
        musicOn: localStorage.getItem('musicOn') === '1',
        userHasInteracted: false,
        currentLang: localStorage.getItem('lang') || 'en',
        settingsListenerAttached: false,
        focusTrapAttached: false,
      };

      // --- i18n ---
      const I18N = {
        en: {
          appName: 'RMC Commercial Team',
          description: 'Quickly access Daily Counting, Stock Counting, Employee Attendance, and Dashboard tools.',
          daily: 'Daily Counting', stock: 'Stock Counting', attendance: 'Attendance',
          info: 'Info', settings: 'Settings', help: 'Help', dashboard: 'Dashboard',
          offline: 'You’re offline. Some actions may not work.',
          opening: 'Opening {label}...',
          unableOpenTitle: 'Unable to open',
          unableOpenBody: 'We couldn’t open {label}. Please try again or check your network.',
          offlineTitle: 'You are offline',
          offlineBody: 'Cannot open {label} while offline. Please check your connection.',
          settingsTitle: 'Application Settings',
          settingsIntro: 'Configure your preferences.',
          language: 'Language',
          bgm: 'Background Music',
          bgmNote: 'Relaxing melody. Music starts after your first interaction due to browser policy.',
          infoBody: '<strong>{appName}</strong><br/>{description}<br/><br/><strong>Admin:</strong> Lakshan • 0772892711',
          helpBody: 'Use the main buttons to launch primary tools. Use the small icons below for Dashboard, Info, Help, and Settings.',
        },
        si: {
          appName: 'RMC වාණිජ කණ්ඩායම',
          description: 'දෛනික ගණන් කිරීම, තොග ගණන් කිරීම, සේවක පැමිණීම සහ ඩෑෂ්බෝඩ් මෙවලම් වෙත ඉක්මනින් පිවිසෙන්න.',
          daily: 'දෛනික ගණන් කිරීම', stock: 'තොග ගණන් කිරීම', attendance: 'පැමිණීම',
          info: 'තොරතුරු', settings: 'සැකසීම්', help: 'උදව්', dashboard: 'ඩෑෂ්බෝර්ඩ්',
          offline: 'ඔබ අන්තර්ජාලයෙන් වෙන් වී ඇත. සමහර ක්‍රියාකාරකම් ක්‍රියා නොවිය හැක.',
          opening: '{label} ආරම්භ වෙමින්...',
          unableOpenTitle: 'විවෘත කළ නොහැක',
          unableOpenBody: '{label} විවෘත කළ නොහැකි විය. කරුණාකර නැවත උත්සාහ කරන්න හෝ ඔබගේ ජාලය පරීක්ෂා කරන්න.',
          offlineTitle: 'ඔබ අන්තර්ජාලයෙන් වෙන් වී ඇත',
          offlineBody: 'අන්තර්ජාලයෙන් වෙන්ව ඇති විට {label} විවෘත කළ නොහැක. කරුණාකර සම්බන්ධතාවය පරීක්ෂා කරන්න.',
          settingsTitle: 'යෙදුම් සැකසීම්',
          settingsIntro: 'ඔබගේ ප්‍රියතම සැකසුම් සකසන්න.',
          language: 'භාෂාව',
          bgm: 'පසුබිම් සංගීතය',
          bgmNote: 'සන්සුන් සංගීතය. බ්‍රව්සර ප්‍රතිපත්තිය හේතුවෙන් ඔබගේ පළමු ක්‍රියාවෙන් පසු සංගීතය ආරම්භ වේ.',
          infoBody: '<strong>{appName}</strong><br/>{description}<br/><br/><strong>පරිපාලක:</strong> Lakshan • 0772892711',
          helpBody: 'ප්‍රධාන බොත්තම් භාවිතා කර මූලික මෙවලම් ඉක්මනින් අරඹන්න. ඩෑෂ්බෝඩ්, තොරතුරු, උදව්, සැකසීම් සඳහා පහත අයිකන භාවිතා කරන්න.',
        },
        ta: {
          appName: 'RMC வர்த்தக குழு',
          description: 'தினசரி எண்ணிக்கை, சரக்கு எண்ணிக்கை, பணியாளர் வருகை மற்றும் டாஷ்போர்டு கருவிகளை விரைவாக அணுகவும்.',
          daily: 'தினசரி எண்ணிக்கை', stock: 'சரக்கு எண்ணிக்கை', attendance: 'வருகை',
          info: 'தகவல்', settings: 'அமைப்புகள்', help: 'உதவி', dashboard: 'டாஷ்போர்டு',
          offline: 'நீங்கள் ஆஃப்லைனில் உள்ளீர்கள். சில செயல்கள் இயங்காது.',
          opening: '{label} திறக்கப்படுகிறது...',
          unableOpenTitle: 'திறக்க முடியவில்லை',
          unableOpenBody: '{label} திறக்க முடியவில்லை. மீண்டும் முயற்சிக்கவும் அல்லது உங்கள் நெட்வொர்க் இணைப்பைச் சரிபார்க்கவும்.',
          offlineTitle: 'நீங்கள் ஆஃப்லைனில் உள்ளீர்கள்',
          offlineBody: 'ஆஃப்லைனில் இருக்கும் போது {label} திறக்க முடியாது. தயவு செய்து இணைப்பைச் சரிபார்க்கவும்.',
          settingsTitle: 'பயன்பாட்டு அமைப்புகள்',
          settingsIntro: 'உங்கள் முன்னுரிமைகளை அமைக்கவும்.',
          language: 'மொழி',
          bgm: 'பின்னணி இசை',
          bgmNote: 'அமைதியான மெலடி. உலாவி கொள்கையினால் முதல் தொடர்புக்குப் பின் இசை தொடங்கும்.',
          infoBody: '<strong>{appName}</strong><br/>{description}<br/><br/><strong>நிர்வாகி:</strong> Lakshan • 0772892711',
          helpBody: 'முக்கிய பொத்தான்களைப் பயன்படுத்தி கருவிகளை விரைவாக தொடங்கவும். டாஷ்போர்டு, தகவல், உதவி, அமைப்புகள் ஆகியவற்றுக்கு கீழே உள்ள ஐகான்களைப் பயன்படுத்தவும்.',
        }
      };

      const t = (key) => (I18N[state.currentLang] && I18N[state.currentLang][key]) || I18N.en[key] || key;
      const tf = (key, params={}) => {
        let s = t(key);
        Object.entries(params).forEach(([k,v]) => s = s.split(`{${k}}`).join(v));
        return s;
      };

      const applyTranslations = () => {
        document.documentElement.lang = state.currentLang;
        document.querySelectorAll('[data-i18n]').forEach(elm => { elm.textContent = t(elm.dataset.i18n); });
        document.querySelectorAll('.grid-item button').forEach(btn => {
          const action = btn.dataset.action;
          if (!action) return;
          const label = t(action);
          btn.setAttribute('aria-label', label);
          btn.setAttribute('title', label);
        });
      };

      // --- THEME ---
      const updateThemeIcon = () => {
        const theme = document.documentElement.dataset.theme || 'light';
        el.themeIcon.className = theme === 'dark' ? 'fa-solid fa-moon' : 'fa-solid fa-sun';
        el.themeToggle.setAttribute('aria-label', `Switch to ${theme === 'dark' ? 'light' : 'dark'} mode`);
      };
      const setTheme = (theme) => { document.documentElement.dataset.theme = theme; localStorage.setItem('theme', theme); updateThemeIcon(); };
      const getPreferredTheme = () => localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');

      // --- LAYOUT SYNC ---
      const syncLayoutVars = () => {
        const offlineHeight = el.offlineBanner.classList.contains('show') ? el.offlineBanner.offsetHeight : 0;
        const footerHeight = el.watermark.offsetHeight;
        document.documentElement.style.setProperty('--offline-h', offlineHeight + 'px');
        document.documentElement.style.setProperty('--footer-h', footerHeight + 'px');
      };

      // --- LOADING ---
      const showLoading = (message = 'Loading...', event = null) => {
        el.main.setAttribute('aria-busy', 'true');
        el.loadingText.textContent = message;
        if (event && (event.clientX || (event.touches && event.touches[0]))) {
          const p = event.touches ? event.touches[0] : event;
          el.loadingOverlay.style.setProperty('--cx', `${p.clientX}px`);
          el.loadingOverlay.style.setProperty('--cy', `${p.clientY}px`);
        } else {
          el.loadingOverlay.style.removeProperty('--cx');
          el.loadingOverlay.style.removeProperty('--cy');
        }
        el.loadingOverlay.classList.add('active');
        el.progressBar.style.width = '0%';
        requestAnimationFrame(() => {
          setTimeout(() => el.progressBar.style.width = '35%', 120);
          setTimeout(() => el.progressBar.style.width = '75%', 520);
          setTimeout(() => el.progressBar.style.width = '100%', 1000);
        });
      };
      const hideLoading = () => {
        el.main.setAttribute('aria-busy', 'false');
        setTimeout(() => {
          el.loadingOverlay.classList.remove('active');
          el.progressBar.style.width = '0%';
        }, 240);
      };

      // --- RIPPLE ---
      const addRipple = (btn, e) => {
        const icon = btn.querySelector('.dock-icon');
        if (!icon) return;
        const rect = icon.getBoundingClientRect();
        let x = rect.width/2, y = rect.height/2;
        if (e) {
          const src = e.touches ? e.touches[0] : e;
          if (typeof src.clientX === 'number') {
            x = src.clientX - rect.left;
            y = src.clientY - rect.top;
          }
        }
        icon.style.setProperty('--px', `${x}px`);
        icon.style.setProperty('--py', `${y}px`);
        btn.classList.remove('ripple'); void icon.offsetWidth; btn.classList.add('ripple');
        setTimeout(() => btn.classList.remove('ripple'), 650);
      };

      // --- MODAL + FOCUS TRAP ---
      const focusableSel = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
      const handleFocusTrap = (e) => {
        if (e.key !== 'Tab') return;
        const focusable = Array.from(el.modal.querySelectorAll(focusableSel)).filter(n => !n.disabled);
        if (!focusable.length) return;
        const first = focusable[0], last = focusable[focusable.length - 1];
        if (e.shiftKey && document.activeElement === first) { last.focus(); e.preventDefault(); }
        else if (!e.shiftKey && document.activeElement === last) { first.focus(); e.preventDefault(); }
      };
      const openModal = (title, html) => {
        state.lastFocused = document.activeElement;
        el.modalTitle.textContent = title;
        el.modalBody.innerHTML = html;
        el.modal.classList.add('show');
        el.modal.setAttribute('aria-hidden', 'false');
        if (!state.focusTrapAttached) {
          el.modal.addEventListener('keydown', handleFocusTrap);
          state.focusTrapAttached = true;
        }
        setTimeout(() => el.modal.querySelector(focusableSel)?.focus(), 40);
      };
      const closeModal = () => {
        el.modal.classList.remove('show');
        el.modal.setAttribute('aria-hidden', 'true');
        if (state.lastFocused && typeof state.lastFocused.focus === 'function') state.lastFocused.focus();
      };

      // --- SETTINGS ---
      const updateSettingsModalTexts = () => {
        el.modalTitle.textContent = t('settingsTitle');
        const p = el.modalBody.querySelector('[data-settings="intro"]');
        const langLabel = el.modalBody.querySelector('[data-settings="lang-label"]');
        const musicLabel = el.modalBody.querySelector('[data-settings="music-label"]');
        const musicNote = el.modalBody.querySelector('[data-settings="music-note"]');
        if (p) p.textContent = t('settingsIntro');
        if (langLabel) langLabel.textContent = t('language');
        if (musicLabel) musicLabel.textContent = t('bgm');
        if (musicNote) musicNote.textContent = t('bgmNote');
      };

      const handleSettingsChange = (e) => {
        const id = e.target.id;
        if (id === 'langSelect') {
          state.currentLang = e.target.value;
          localStorage.setItem('lang', state.currentLang);
          applyTranslations();
          updateSettingsModalTexts();
        } else if (id === 'musicToggle') {
          state.musicOn = e.target.checked;
          localStorage.setItem('musicOn', state.musicOn ? '1' : '0');
          if (state.musicOn) startMusic(); else stopMusic();
        }
      };

      const openSettings = () => {
        const html = `
          <div style="display:grid; gap:16px;">
            <p data-settings="intro" style="margin:0; color:var(--muted);">${t('settingsIntro')}</p>

            <div style="display:grid; gap:6px;">
              <label data-settings="lang-label" for="langSelect" style="font-weight:600;">${t('language')}</label>
              <select id="langSelect">
                <option value="en"${state.currentLang==='en'?' selected':''}>English</option>
                <option value="si"${state.currentLang==='si'?' selected':''}>සිංහල (Sinhala)</option>
                <option value="ta"${state.currentLang==='ta'?' selected':''}>தமிழ் (Tamil)</option>
              </select>
            </div>

            <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
              <label data-settings="music-label" for="musicToggle" style="font-weight:600;">${t('bgm')}</label>
              <label class="switch">
                <input type="checkbox" id="musicToggle" ${state.musicOn ? 'checked' : ''} />
                <span class="slider"></span>
              </label>
            </div>

            <small data-settings="music-note" style="color:var(--muted);">${t('bgmNote')}</small>
          </div>
        `;
        openModal(t('settingsTitle'), html);
        if (!state.settingsListenerAttached) {
          el.modalBody.addEventListener('change', handleSettingsChange);
          state.settingsListenerAttached = true;
        }
      };

      const openInfo = () => openModal(t('info'), tf('infoBody', { appName: t('appName'), description: t('description') }));
      const openHelp = () => openModal(t('help'), t('helpBody'));

      // --- ACTIONS / NAVIGATION ---
      const safeNavigate = (url, labelKey, event) => {
        const label = t(labelKey);
        if (!navigator.onLine) return openModal(t('offlineTitle'), tf('offlineBody', {label}));
        showLoading(tf('opening', {label}), event);
        const navTimeout = setTimeout(() => {
          if (document.visibilityState === 'visible') {
            hideLoading();
            openModal(t('unableOpenTitle'), tf('unableOpenBody', {label}));
          }
        }, 8000);
        setTimeout(() => { window.location.href = url; }, 500);
        window.addEventListener('pagehide', () => clearTimeout(navTimeout), { once: true });
      };

      // Buttons: click + keyboard access (Enter/Space)
      const bindAction = (btn, handler) => {
        btn.addEventListener('click', (e) => handler(e));
        btn.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); handler(e); }
        });
      };

      // --- MUSIC (robust, fallback chain + autoplay unlock) ---
      let bgmReady = false;
      let bgmReadyPromise = null;

      const BGM_SOURCES = (el.bgm.dataset.srcs || '').split('|').filter(Boolean);
      const DEFAULT_FALLBACK = 'https://cdn.pixabay.com/download/audio/2021/10/26/audio_2f4d9c74f8.mp3?filename=relaxing-ambient-108163.mp3';

      const tryLoadAudio = (url, timeout = 6000) => new Promise((resolve) => {
        const a = el.bgm;
        const onReady = () => { cleanup(); resolve(true); };
        const onError = () => { cleanup(); resolve(false); };
        const cleanup = () => {
          a.removeEventListener('canplaythrough', onReady);
          a.removeEventListener('loadeddata', onReady);
          a.removeEventListener('loadedmetadata', onReady);
          a.removeEventListener('error', onError);
          clearTimeout(to);
        };
        a.src = url;
        a.load();
        a.addEventListener('canplaythrough', onReady, { once: true });
        a.addEventListener('loadeddata', onReady, { once: true });
        a.addEventListener('loadedmetadata', onReady, { once: true });
        a.addEventListener('error', onError, { once: true });
        const to = setTimeout(onError, timeout);
      });

      const setupBgm = async () => {
        const candidates = BGM_SOURCES.length ? BGM_SOURCES : [DEFAULT_FALLBACK];
        for (const url of candidates) {
          const ok = await tryLoadAudio(url);
          if (ok) { bgmReady = true; return true; }
        }
        // ensure some source even if all failed
        await tryLoadAudio(DEFAULT_FALLBACK);
        bgmReady = true;
        return true;
      };

      const startMusic = async () => {
        if (!state.musicOn) return;
        if (!bgmReady) {
          if (!bgmReadyPromise) bgmReadyPromise = setupBgm();
          await bgmReadyPromise;
        }
        try {
          el.bgm.volume = 0.35;
          await el.bgm.play();
        } catch (err) {
          // Autoplay blocked until user gesture; will retry on first interaction.
        }
      };

      const stopMusic = () => {
        el.bgm.pause();
        // keep position if user toggles off/on; reset if you prefer: el.bgm.currentTime = 0;
      };

      // If current audio stalls/errors later, try to re-setup and resume
      const recoverBgm = async () => {
        bgmReady = false;
        bgmReadyPromise = setupBgm();
        await bgmReadyPromise;
        if (state.musicOn && state.userHasInteracted) {
          try { await el.bgm.play(); } catch(_) {}
        }
      };
      el.bgm.addEventListener('error', recoverBgm);
      el.bgm.addEventListener('stalled', recoverBgm);

      const handleFirstInteraction = () => {
        if (state.userHasInteracted) return;
        state.userHasInteracted = true;
        startMusic();
      };

      // --- INIT ---
      const init = () => {
        setTheme(getPreferredTheme());
        applyTranslations();
        updateThemeIcon();

        // Bind main actions
        bindAction(el.launchBtn, (e) => { addRipple(el.launchBtn, e); safeNavigate(URLS.DAILY, 'daily', e); });
        bindAction(el.stockBtn, (e) => { addRipple(el.stockBtn, e); safeNavigate(URLS.STOCK, 'stock', e); });
        bindAction(el.attendanceBtn, (e) => { addRipple(el.attendanceBtn, e); safeNavigate(URLS.ATTENDANCE, 'attendance', e); });

        // Grid actions
        document.querySelectorAll('.grid-item button').forEach(btn => {
          const action = btn.dataset.action;
          if (action === 'settings') bindAction(btn, openSettings);
          if (action === 'info') bindAction(btn, openInfo);
          if (action === 'help') bindAction(btn, openHelp);
          if (action === 'dashboard') bindAction(btn, (e) => safeNavigate(URLS.DASHBOARD, 'dashboard', e));
        });

        // Theme toggle
        el.themeToggle.addEventListener('click', () => {
          const cur = document.documentElement.dataset.theme || 'light';
          setTheme(cur === 'dark' ? 'light' : 'dark');
        });

        // Modal close
        el.modalClose.addEventListener('click', closeModal);
        el.modal.addEventListener('click', (e) => { if (e.target === el.modal) closeModal(); });
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && el.modal.classList.contains('show')) closeModal(); });

        // Offline banner
        const setOfflineBanner = () => {
          el.offlineBanner.classList.toggle('show', !navigator.onLine);
          syncLayoutVars();
        };
        window.addEventListener('online', setOfflineBanner);
        window.addEventListener('offline', setOfflineBanner);
        setOfflineBanner();

        // Keep layout synced on resize
        window.addEventListener('resize', syncLayoutVars);
        syncLayoutVars();

        // Hide loader if returning via bfcache
        window.addEventListener('pageshow', (e) => { if (e.persisted) hideLoading(); });

        // Prepare BGM sources early
        bgmReadyPromise = setupBgm();

        // First interaction for BGM (autoplay policy)
        ['pointerdown', 'keydown'].forEach(evt => {
          document.body.addEventListener(evt, handleFirstInteraction, { once: true, capture: true });
        });
      };

      if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
      else init();
    })();
  </script>
</body>
</html>
